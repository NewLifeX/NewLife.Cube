# 第10章 多租户架构

> 本章介绍魔方的多租户架构，实现 SaaS 模式下的租户数据隔离。
> 
> 详细教程：https://newlifex.com/cube/cube_tenant

---

## 10.1 多租户设计原理

### 什么是多租户

多租户（Multi-Tenancy）是一种软件架构模式，允许单个应用实例为多个租户（客户/组织）提供服务，同时保证数据和配置的隔离。

### 多租户模式对比

| 模式 | 数据库 | 表 | 隔离级别 | 成本 | 适用场景 |
|------|--------|-----|---------|------|---------|
| 独立数据库 | 每租户独立 | 独立 | 最高 | 高 | 大客户/高安全要求 |
| 共享数据库独立Schema | 共享 | 每租户独立 | 高 | 中 | 中型SaaS |
| **共享表（魔方方案）** | 共享 | 共享+TenantId | 中 | 低 | 标准SaaS |

### 魔方多租户架构

魔方采用 **共享数据库+TenantId 字段** 的方式实现多租户：

```
┌─────────────────────────────────────────┐
│              应用服务器                  │
├─────────────────────────────────────────┤
│         TenantMiddleware                 │
│    （识别租户、设置租户上下文）            │
├─────────────────────────────────────────┤
│              数据访问层                   │
│    （自动添加 TenantId 过滤条件）         │
├─────────────────────────────────────────┤
│              数据库                       │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │租户A│ │租户B│ │租户C│ │租户D│      │
│  │数据 │ │数据 │ │数据 │ │数据 │      │
│  └─────┘ └─────┘ └─────┘ └─────┘      │
│        （同一张表，TenantId区分）         │
└─────────────────────────────────────────┘
```

---

## 10.2 核心组件

### Tenant 租户实体

```csharp
public partial class Tenant : Entity<Tenant>
{
    /// <summary>租户ID</summary>
    public Int32 Id { get; set; }
    
    /// <summary>租户名称</summary>
    public String Name { get; set; }
    
    /// <summary>租户编码（用于URL识别）</summary>
    public String Code { get; set; }
    
    /// <summary>域名（用于域名识别）</summary>
    public String Domain { get; set; }
    
    /// <summary>是否启用</summary>
    public Boolean Enable { get; set; }
    
    /// <summary>到期时间</summary>
    public DateTime ExpireTime { get; set; }
    
    /// <summary>最大用户数</summary>
    public Int32 MaxUsers { get; set; }
    
    /// <summary>存储空间（MB）</summary>
    public Int64 StorageQuota { get; set; }
}
```

### ITenant 接口

```csharp
public interface ITenant
{
    /// <summary>租户ID</summary>
    Int32 TenantId { get; set; }
}

// 实体实现接口
public partial class Product : Entity<Product>, ITenant
{
    public Int32 TenantId { get; set; }
    // ... 其他字段
}
```

### TenantContext 租户上下文

```csharp
public static class TenantContext
{
    /// <summary>当前租户ID</summary>
    public static Int32 CurrentTenantId => _current.Value;
    
    /// <summary>当前租户</summary>
    public static Tenant Current => Tenant.FindById(CurrentTenantId);
    
    private static readonly AsyncLocal<Int32> _current = new();
    
    /// <summary>设置当前租户</summary>
    public static void SetTenant(Int32 tenantId)
    {
        _current.Value = tenantId;
    }
}
```

### TenantMiddleware 中间件

```csharp
public class TenantMiddleware
{
    private readonly RequestDelegate _next;
    
    public TenantMiddleware(RequestDelegate next)
    {
        _next = next;
    }
    
    public async Task InvokeAsync(HttpContext context)
    {
        // 识别租户
        var tenantId = ResolveTenant(context);
        
        // 设置租户上下文
        TenantContext.SetTenant(tenantId);
        
        await _next(context);
    }
    
    private Int32 ResolveTenant(HttpContext context)
    {
        // 方式1：从域名识别
        var host = context.Request.Host.Host;
        var tenant = Tenant.FindByDomain(host);
        if (tenant != null) return tenant.Id;
        
        // 方式2：从URL路径识别（/tenant/abc/...）
        var path = context.Request.Path.Value;
        var match = Regex.Match(path, @"^/tenant/(\w+)/");
        if (match.Success)
        {
            tenant = Tenant.FindByCode(match.Groups[1].Value);
            if (tenant != null) return tenant.Id;
        }
        
        // 方式3：从请求头识别
        if (context.Request.Headers.TryGetValue("X-Tenant-Id", out var headerValue))
        {
            return headerValue.ToString().ToInt();
        }
        
        // 方式4：从登录用户识别
        var user = context.User.Identity as IUser;
        if (user != null) return user.TenantId;
        
        // 默认租户
        return 0;
    }
}
```

---

## 10.3 租户隔离

### 数据自动隔离

实现 `ITenant` 接口的实体会自动进行数据隔离：

```csharp
// 实体定义
public partial class Product : Entity<Product>, ITenant
{
    public Int32 TenantId { get; set; }
    public String Name { get; set; }
    public Decimal Price { get; set; }
}

// 查询时自动添加 TenantId 条件
var products = Product.FindAll();
// 实际SQL：SELECT * FROM Product WHERE TenantId = @CurrentTenantId

// 保存时自动设置 TenantId
var product = new Product { Name = "测试产品", Price = 99 };
product.Insert();  // 自动设置 TenantId = TenantContext.CurrentTenantId
```

### 跳过租户隔离

某些场景需要跳过租户隔离（如系统管理员操作）：

```csharp
// 使用 using 块临时禁用租户隔离
using (TenantContext.SkipTenant())
{
    // 这里的查询不会自动添加 TenantId 条件
    var allProducts = Product.FindAll();
}

// 或者使用显式条件
var allProducts = Product.FindAll(Product._.TenantId > 0, null, null, 0, 0);
```

### 跨租户操作

系统管理员的跨租户操作：

```csharp
// 切换租户上下文
public ActionResult SwitchTenant(Int32 tenantId)
{
    // 验证权限
    if (!CurrentUser.IsSystemAdmin)
        return Unauthorized();
    
    // 切换租户
    TenantContext.SetTenant(tenantId);
    
    return RedirectToAction("Index");
}
```

---

## 10.4 租户切换

### 登录时选择租户

```csharp
public ActionResult Login(String username, String password, Int32 tenantId)
{
    // 设置租户上下文
    TenantContext.SetTenant(tenantId);
    
    // 在指定租户范围内查找用户
    var user = User.FindByName(username);
    if (user == null || !user.VerifyPassword(password))
        return Json(new { code = 500, msg = "用户名或密码错误" });
    
    // 登录成功
    ManageProvider.Provider.Current = user;
    
    return Json(new { code = 0, msg = "登录成功" });
}
```

### 租户选择界面

```html
<form action="/Login" method="post">
    <div class="form-group">
        <label>选择租户</label>
        <select name="tenantId" class="form-control">
            @foreach (var tenant in ViewBag.Tenants)
            {
                <option value="@tenant.Id">@tenant.Name</option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>用户名</label>
        <input type="text" name="username" class="form-control" />
    </div>
    <div class="form-group">
        <label>密码</label>
        <input type="password" name="password" class="form-control" />
    </div>
    <button type="submit" class="btn btn-primary">登录</button>
</form>
```

### 运行时切换租户

```csharp
// 管理员可以在运行时切换租户
[EntityAuthorize(PermissionFlags.All)]
public ActionResult SwitchTenant(Int32 id)
{
    var tenant = Tenant.FindById(id);
    if (tenant == null)
        return Json(500, null, "租户不存在");
    
    // 更新会话中的租户信息
    Session["TenantId"] = id;
    
    // 重新加载用户信息
    var user = ManageProvider.User as User;
    user.TenantId = id;
    
    return Json(0, null, $"已切换到租户：{tenant.Name}");
}
```

---

## 10.5 使用方式

### 启用多租户

在 `Startup.cs` 中配置：

```csharp
public void ConfigureServices(IServiceCollection services)
{
    // 添加魔方服务
    services.AddCube();
    
    // 启用多租户
    services.AddTenant();
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // 使用租户中间件（必须在认证之前）
    app.UseTenantMiddleware();
    
    app.UseAuthentication();
    app.UseAuthorization();
    
    app.UseCube(env);
}
```

### 实体添加租户支持

```csharp
// 1. 实体实现 ITenant 接口
public partial class Order : Entity<Order>, ITenant
{
    public Int32 TenantId { get; set; }
    
    // ... 其他字段
}

// 2. 在 Model.xml 中添加 TenantId 字段
// <Column Name="TenantId" DataType="Int32" Description="租户" />
```

### 控制器配置

```csharp
// 控制器会自动应用租户隔离
public class OrderController : EntityController<Order>
{
    // 查询自动添加 TenantId 条件
    // 保存自动设置 TenantId
}
```

### 租户管理功能

```csharp
// 租户管理控制器（系统管理员专用）
[Menu("租户管理")]
public class TenantController : EntityController<Tenant>
{
    static TenantController()
    {
        ListFields.RemoveField("Remark");
        
        // 显示统计信息
        ListFields.AddListField("UserCount", "用户数");
        ListFields.AddListField("DataCount", "数据量");
    }
    
    // 创建租户时初始化数据
    protected override Int32 OnInsert(Tenant entity)
    {
        var count = base.OnInsert(entity);
        
        // 初始化租户管理员
        InitTenantAdmin(entity);
        
        // 初始化默认数据
        InitDefaultData(entity);
        
        return count;
    }
    
    private void InitTenantAdmin(Tenant tenant)
    {
        using (TenantContext.SwitchTo(tenant.Id))
        {
            var admin = new User
            {
                Name = "admin",
                DisplayName = "管理员",
                Password = "admin".MD5(),
                RoleId = Role.GetOrAdd("管理员").Id,
                TenantId = tenant.Id
            };
            admin.Insert();
        }
    }
    
    private void InitDefaultData(Tenant tenant)
    {
        // 初始化租户默认角色、菜单等
    }
}
```

---

## 多租户最佳实践

### 1. 租户标识设计

```csharp
// 支持多种租户识别方式
public enum TenantResolveMode
{
    /// <summary>域名识别（xxx.saas.com）</summary>
    Domain,
    
    /// <summary>子路径识别（/tenant/xxx/）</summary>
    Path,
    
    /// <summary>请求头识别（X-Tenant-Id）</summary>
    Header,
    
    /// <summary>查询参数识别（?tenantId=xxx）</summary>
    Query
}
```

### 2. 租户数据初始化

```csharp
// 新租户创建时的数据初始化模板
public class TenantInitializer
{
    public void Initialize(Tenant tenant)
    {
        using (TenantContext.SwitchTo(tenant.Id))
        {
            // 1. 创建默认角色
            CreateDefaultRoles();
            
            // 2. 创建管理员用户
            CreateAdminUser(tenant);
            
            // 3. 初始化基础数据
            InitBaseData();
            
            // 4. 初始化菜单权限
            InitMenuPermissions();
        }
    }
}
```

### 3. 租户资源配额

```csharp
// 检查租户配额
public Boolean CheckQuota(Tenant tenant, String resourceType)
{
    return resourceType switch
    {
        "User" => User.FindCountByTenantId(tenant.Id) < tenant.MaxUsers,
        "Storage" => GetUsedStorage(tenant.Id) < tenant.StorageQuota,
        "Api" => GetApiCallCount(tenant.Id) < tenant.MaxApiCalls,
        _ => true
    };
}
```

### 4. 租户数据备份

```csharp
// 导出租户数据
public Byte[] ExportTenantData(Int32 tenantId)
{
    using (TenantContext.SwitchTo(tenantId))
    {
        var data = new TenantBackup
        {
            Users = User.FindAll().ToList(),
            Roles = Role.FindAll().ToList(),
            Products = Product.FindAll().ToList(),
            Orders = Order.FindAll().ToList()
        };
        
        return data.ToJson().GetBytes();
    }
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **多租户概念**：理解 SaaS 模式下的数据隔离需求
2. **核心组件**：Tenant 实体、ITenant 接口、TenantContext
3. **数据隔离**：自动的租户数据隔离机制
4. **租户切换**：登录选择和运行时切换
5. **使用配置**：启用多租户和实体配置

**下一步**：

- 学习 [安全与审计](安全与审计.md) 了解安全增强措施
- 了解 [用户认证](用户认证.md) 的多租户登录流程

---

## 参考资源

- [魔方多租户架构](https://newlifex.com/cube/cube_tenant)
