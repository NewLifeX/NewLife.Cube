# 第5章 数据导入导出

> 本章介绍魔方的数据导入导出功能，支持 Excel、CSV、JSON、XML 等多种格式。
> 
> 详细教程：https://newlifex.com/cube/export

---

## 5.1 数据导出

魔方内置强大的数据导出功能，支持多种格式和导出范围。

### Excel 导出

Excel 是最常用的导出格式，支持 `.xlsx` 格式：

```csharp
// 默认已内置，无需额外代码
// 列表页工具栏自动显示"导出Excel"按钮
```

**导出配置**：

```csharp
static ProductController()
{
    // 配置导出字段（默认使用 ListFields）
    ListFields.RemoveField("InternalCode");  // 排除内部字段
    
    // 设置导出文件名
    // 默认格式：{实体名}_{日期时间}.xlsx
}
```

**自定义导出逻辑**：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("导出Excel")]
public virtual ActionResult ExportExcel()
{
    // 获取要导出的数据
    var list = SearchAll();
    
    // 自定义导出字段
    var fields = new[] { "Name", "Code", "Price", "CreateTime" };
    
    // 导出
    var ms = list.Export(fields);
    
    return File(ms, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
        $"产品列表_{DateTime.Now:yyyyMMddHHmmss}.xlsx");
}
```

### CSV 导出

CSV 格式适合大数据量导出和跨平台使用：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("导出CSV")]
public virtual ActionResult ExportCsv()
{
    var list = SearchAll();
    
    var sb = new StringBuilder();
    
    // 写入标题行
    sb.AppendLine("名称,编码,价格,创建时间");
    
    // 写入数据行
    foreach (var item in list)
    {
        sb.AppendLine($"{item.Name},{item.Code},{item.Price},{item.CreateTime:yyyy-MM-dd HH:mm:ss}");
    }
    
    var bytes = Encoding.UTF8.GetBytes(sb.ToString());
    return File(bytes, "text/csv", $"产品列表_{DateTime.Now:yyyyMMddHHmmss}.csv");
}
```

### Json 导出

JSON 格式适合 API 对接和数据交换：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("导出JSON")]
public virtual ActionResult ExportJson()
{
    var list = SearchAll();
    
    var json = list.ToJson(true);  // true 表示格式化输出
    
    var bytes = Encoding.UTF8.GetBytes(json);
    return File(bytes, "application/json", $"产品列表_{DateTime.Now:yyyyMMddHHmmss}.json");
}
```

### Xml 导出

XML 格式适合与传统系统对接：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("导出XML")]
public virtual ActionResult ExportXml()
{
    var list = SearchAll();
    
    var xml = list.ToXml();
    
    var bytes = Encoding.UTF8.GetBytes(xml);
    return File(bytes, "application/xml", $"产品列表_{DateTime.Now:yyyyMMddHHmmss}.xml");
}
```

### 导出当前页 vs 导出全部

魔方支持两种导出范围：

| 导出方式 | 说明 | 适用场景 |
|---------|------|----------|
| 导出当前页 | 仅导出当前分页的数据 | 快速导出、数据量小 |
| 导出全部 | 导出所有符合条件的数据 | 数据备份、报表生成 |

```csharp
// 导出当前页（使用分页参数）
protected virtual IEnumerable<Product> Search(Pager p)
{
    return Product.Search(p["name"], p);
}

// 导出全部（不使用分页）
protected virtual IEnumerable<Product> SearchAll()
{
    var p = new Pager { PageSize = 0 };  // PageSize=0 表示不分页
    return Product.Search(p["name"], p);
}
```

---

## 5.2 数据导入

### 导入模板下载

提供标准导入模板，确保数据格式正确：

```csharp
[EntityAuthorize(PermissionFlags.Insert)]
[DisplayName("下载导入模板")]
public virtual ActionResult DownloadTemplate()
{
    // 创建空数据作为模板
    var list = new List<Product>
    {
        new Product { Name = "示例产品", Code = "P001", Price = 99.00M }
    };
    
    var fields = new[] { "Name", "Code", "Price", "CategoryId" };
    var ms = list.Export(fields);
    
    return File(ms, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
        "产品导入模板.xlsx");
}
```

### Excel 数据导入

```csharp
[EntityAuthorize(PermissionFlags.Insert)]
[DisplayName("导入Excel")]
[HttpPost]
public virtual ActionResult ImportExcel(IFormFile file)
{
    if (file == null || file.Length == 0)
        return Json(500, null, "请选择要导入的文件");
    
    try
    {
        using var stream = file.OpenReadStream();
        var list = stream.Import<Product>();
        
        var success = 0;
        var errors = new List<String>();
        
        foreach (var item in list)
        {
            try
            {
                // 数据校验
                if (item.Name.IsNullOrEmpty())
                {
                    errors.Add($"第 {list.IndexOf(item) + 2} 行：名称不能为空");
                    continue;
                }
                
                // 检查重复
                var exist = Product.FindByCode(item.Code);
                if (exist != null)
                {
                    errors.Add($"第 {list.IndexOf(item) + 2} 行：编码 {item.Code} 已存在");
                    continue;
                }
                
                // 保存数据
                item.Insert();
                success++;
            }
            catch (Exception ex)
            {
                errors.Add($"第 {list.IndexOf(item) + 2} 行：{ex.Message}");
            }
        }
        
        var msg = $"导入完成，成功 {success} 条";
        if (errors.Count > 0)
            msg += $"，失败 {errors.Count} 条：\n" + String.Join("\n", errors.Take(10));
        
        return Json(0, null, msg);
    }
    catch (Exception ex)
    {
        return Json(500, null, $"导入失败：{ex.Message}");
    }
}
```

### 导入错误处理

完善的错误处理机制：

```csharp
public class ImportResult
{
    /// <summary>成功数量</summary>
    public Int32 SuccessCount { get; set; }
    
    /// <summary>失败数量</summary>
    public Int32 FailCount { get; set; }
    
    /// <summary>错误列表</summary>
    public List<ImportError> Errors { get; set; } = new();
}

public class ImportError
{
    /// <summary>行号</summary>
    public Int32 RowIndex { get; set; }
    
    /// <summary>错误信息</summary>
    public String Message { get; set; }
    
    /// <summary>原始数据</summary>
    public String RawData { get; set; }
}
```

**导入流程**：

```
1. 上传文件
   ↓
2. 解析数据
   ↓
3. 数据校验（格式、必填、唯一性）
   ↓
4. 批量保存
   ↓
5. 返回结果（成功/失败数量、错误详情）
```

---

## 5.3 数据分享

### 分享链接生成

生成可分享的数据链接：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("生成分享链接")]
public virtual ActionResult Share(Int32 id)
{
    var entity = Product.FindById(id);
    if (entity == null)
        return Json(500, null, "数据不存在");
    
    // 生成分享令牌
    var token = GenerateShareToken(id);
    
    // 构建分享链接
    var url = $"{Request.Scheme}://{Request.Host}/Share/Product/{token}";
    
    return Json(0, url, "分享链接生成成功");
}

private String GenerateShareToken(Int32 id)
{
    // 生成带过期时间的令牌
    var data = new { Id = id, Expire = DateTime.Now.AddDays(7) };
    return data.ToJson().MD5();
}
```

### 分享权限设置

控制分享内容的访问权限：

```csharp
public class ShareConfig
{
    /// <summary>是否需要登录</summary>
    public Boolean RequireLogin { get; set; }
    
    /// <summary>过期时间（小时）</summary>
    public Int32 ExpireHours { get; set; } = 24;
    
    /// <summary>允许的字段</summary>
    public String[] AllowedFields { get; set; }
    
    /// <summary>访问次数限制</summary>
    public Int32 MaxAccessCount { get; set; }
}
```

---

## 导出格式对比

| 格式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| Excel (.xlsx) | 格式丰富、易于阅读 | 文件较大 | 报表、人工处理 |
| CSV | 轻量、通用性强 | 不支持格式 | 大数据量、跨平台 |
| JSON | 结构化、易于编程处理 | 可读性一般 | API 对接、数据交换 |
| XML | 结构化、支持复杂数据 | 冗余较多 | 传统系统对接 |

---

## 最佳实践

### 1. 大数据量导出

对于大量数据的导出，建议：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
public async Task<ActionResult> ExportLargeData()
{
    // 使用流式导出，避免内存溢出
    Response.ContentType = "application/octet-stream";
    Response.Headers["Content-Disposition"] = 
        $"attachment; filename=export_{DateTime.Now:yyyyMMddHHmmss}.csv";
    
    await using var writer = new StreamWriter(Response.Body);
    
    // 写入标题
    await writer.WriteLineAsync("Id,Name,Code,Price");
    
    // 分批查询并写入
    var pageSize = 10000;
    var pageIndex = 1;
    
    while (true)
    {
        var list = Product.FindAll(null, null, null, (pageIndex - 1) * pageSize, pageSize);
        if (list.Count == 0) break;
        
        foreach (var item in list)
        {
            await writer.WriteLineAsync($"{item.Id},{item.Name},{item.Code},{item.Price}");
        }
        
        pageIndex++;
    }
    
    return new EmptyResult();
}
```

### 2. 导入数据校验

```csharp
private List<String> ValidateImportData(Product item, Int32 rowIndex)
{
    var errors = new List<String>();
    
    // 必填校验
    if (item.Name.IsNullOrEmpty())
        errors.Add($"行{rowIndex}：名称不能为空");
    
    // 格式校验
    if (item.Price < 0)
        errors.Add($"行{rowIndex}：价格不能为负数");
    
    // 唯一性校验
    if (!item.Code.IsNullOrEmpty() && Product.FindByCode(item.Code) != null)
        errors.Add($"行{rowIndex}：编码 {item.Code} 已存在");
    
    // 关联校验
    if (item.CategoryId > 0 && Category.FindById(item.CategoryId) == null)
        errors.Add($"行{rowIndex}：分类ID {item.CategoryId} 不存在");
    
    return errors;
}
```

### 3. 导出字段安全

```csharp
static ProductController()
{
    // 导出时排除敏感字段
    ListFields.RemoveField("Password", "InternalCode", "Cost");
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **数据导出**：Excel、CSV、JSON、XML 多种格式导出
2. **数据导入**：模板下载、Excel 导入、错误处理
3. **数据分享**：分享链接生成和权限控制
4. **最佳实践**：大数据量处理、数据校验、安全控制

**下一步**：

- 学习 [字段元数据](字段元数据.md) 了解字段配置
- 了解 [菜单系统](菜单系统.md) 的管理方法

---

## 参考资源

- [数据导出（Excel/Csv/Json/Xml）](https://newlifex.com/cube/export)
