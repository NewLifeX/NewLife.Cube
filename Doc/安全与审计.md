# 第11章 安全与审计

> 本章介绍魔方的安全功能和审计机制，帮助系统满足安全合规要求。
> 
> 详细教程：https://newlifex.com/cube/cube_security

---

## 11.1 安全功能概述

魔方提供多层次的安全防护：

| 层次 | 功能 | 说明 |
|------|------|------|
| 传输层 | HTTPS | 加密数据传输 |
| 认证层 | 密码策略/多因素认证 | 身份验证 |
| 授权层 | RBAC 权限/数据权限 | 访问控制 |
| 应用层 | 登录限制/风控 | 异常行为防护 |
| 审计层 | 操作日志/访问日志 | 行为追溯 |

---

## 11.2 HTTPS 配置

### ASP.NET Core HTTPS 配置

```csharp
public void ConfigureServices(IServiceCollection services)
{
    // 强制 HTTPS
    services.AddHttpsRedirection(options =>
    {
        options.RedirectStatusCode = StatusCodes.Status307TemporaryRedirect;
        options.HttpsPort = 443;
    });
    
    // HSTS（HTTP 严格传输安全）
    services.AddHsts(options =>
    {
        options.Preload = true;
        options.IncludeSubDomains = true;
        options.MaxAge = TimeSpan.FromDays(365);
    });
}

public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (!env.IsDevelopment())
    {
        app.UseHsts();
    }
    
    app.UseHttpsRedirection();
}
```

### Kestrel 证书配置

```json
// appsettings.json
{
  "Kestrel": {
    "Endpoints": {
      "Https": {
        "Url": "https://*:443",
        "Certificate": {
          "Path": "cert.pfx",
          "Password": "your-password"
        }
      }
    }
  }
}
```

---

## 11.3 密码策略与密码强度

### 密码策略配置

```csharp
// CubeSetting.cs 配置
public class CubeSetting
{
    /// <summary>密码最小长度</summary>
    public Int32 PasswordMinLength { get; set; } = 8;
    
    /// <summary>是否要求大写字母</summary>
    public Boolean PasswordRequireUppercase { get; set; } = true;
    
    /// <summary>是否要求小写字母</summary>
    public Boolean PasswordRequireLowercase { get; set; } = true;
    
    /// <summary>是否要求数字</summary>
    public Boolean PasswordRequireDigit { get; set; } = true;
    
    /// <summary>是否要求特殊字符</summary>
    public Boolean PasswordRequireSpecialChar { get; set; } = false;
    
    /// <summary>密码过期天数（0表示不过期）</summary>
    public Int32 PasswordExpireDays { get; set; } = 90;
    
    /// <summary>历史密码记录数（防止重复使用）</summary>
    public Int32 PasswordHistoryCount { get; set; } = 5;
}
```

### 密码强度验证

```csharp
public class PasswordValidator
{
    private readonly CubeSetting _setting;
    
    public PasswordValidator(CubeSetting setting)
    {
        _setting = setting;
    }
    
    public (Boolean Success, String Message) Validate(String password)
    {
        if (password.IsNullOrEmpty())
            return (false, "密码不能为空");
        
        if (password.Length < _setting.PasswordMinLength)
            return (false, $"密码长度不能少于{_setting.PasswordMinLength}位");
        
        if (_setting.PasswordRequireUppercase && !password.Any(Char.IsUpper))
            return (false, "密码必须包含大写字母");
        
        if (_setting.PasswordRequireLowercase && !password.Any(Char.IsLower))
            return (false, "密码必须包含小写字母");
        
        if (_setting.PasswordRequireDigit && !password.Any(Char.IsDigit))
            return (false, "密码必须包含数字");
        
        if (_setting.PasswordRequireSpecialChar && 
            !password.Any(c => "!@#$%^&*()_+-=[]{}|;':\",./<>?".Contains(c)))
            return (false, "密码必须包含特殊字符");
        
        return (true, "密码强度符合要求");
    }
}
```

### 密码加密存储

```csharp
// 密码加密（使用 MD5 + Salt）
public String HashPassword(String password, String salt = null)
{
    salt ??= Rand.NextString(8);
    var hash = $"{password}{salt}".MD5();
    return $"{salt}${hash}";
}

// 密码验证
public Boolean VerifyPassword(String password, String hashedPassword)
{
    var parts = hashedPassword.Split('$');
    if (parts.Length != 2) return false;
    
    var salt = parts[0];
    var expected = $"{salt}${$"{password}{salt}".MD5()}";
    
    return hashedPassword == expected;
}
```

---

## 11.4 登录限制与风控

### 登录失败限制

```csharp
public class LoginAttemptService
{
    private readonly ICache _cache;
    private readonly CubeSetting _setting;
    
    /// <summary>最大尝试次数</summary>
    public Int32 MaxAttempts => _setting.LoginMaxAttempts;
    
    /// <summary>锁定时间（分钟）</summary>
    public Int32 LockMinutes => _setting.LoginLockMinutes;
    
    public Boolean IsLocked(String username)
    {
        var key = $"login:lock:{username}";
        return _cache.Get<Boolean>(key);
    }
    
    public void RecordFailure(String username, String ip)
    {
        var key = $"login:attempts:{username}";
        var attempts = _cache.Get<Int32>(key) + 1;
        
        if (attempts >= MaxAttempts)
        {
            // 锁定账户
            _cache.Set($"login:lock:{username}", true, LockMinutes * 60);
            
            // 记录安全日志
            WriteSecurityLog(username, ip, "账户被锁定");
        }
        else
        {
            _cache.Set(key, attempts, 300);  // 5分钟内的尝试次数
        }
    }
    
    public void ClearAttempts(String username)
    {
        _cache.Remove($"login:attempts:{username}");
        _cache.Remove($"login:lock:{username}");
    }
}
```

### IP 黑名单

```csharp
public class IpBlacklistService
{
    public Boolean IsBlocked(String ip)
    {
        // 检查是否在黑名单中
        var rule = AccessRule.FindByIp(ip);
        return rule?.Action == "Block";
    }
    
    public void Block(String ip, String reason, Int32 minutes = 60)
    {
        var rule = new AccessRule
        {
            Ip = ip,
            Action = "Block",
            Reason = reason,
            ExpireTime = DateTime.Now.AddMinutes(minutes)
        };
        rule.Insert();
    }
}
```

### 异常行为检测

```csharp
public class SecurityMonitor
{
    public void CheckAbnormalBehavior(String userId, String action)
    {
        // 短时间内大量操作
        var recentCount = GetRecentActionCount(userId, action, 60);  // 1分钟内
        if (recentCount > 100)
        {
            WriteSecurityAlert(userId, "操作频率异常", $"1分钟内{action}操作{recentCount}次");
        }
        
        // 异常时间段操作
        var hour = DateTime.Now.Hour;
        if (hour >= 0 && hour < 6)
        {
            WriteSecurityLog(userId, "非工作时间操作", action);
        }
        
        // 异常地理位置
        var currentIp = GetCurrentIp();
        var lastIp = GetLastLoginIp(userId);
        if (!IsSameRegion(currentIp, lastIp))
        {
            WriteSecurityAlert(userId, "异地登录", $"IP从{lastIp}变为{currentIp}");
        }
    }
}
```

---

## 11.5 敏感数据保护

### 数据脱敏

```csharp
public static class DataMaskHelper
{
    /// <summary>手机号脱敏</summary>
    public static String MaskPhone(String phone)
    {
        if (phone.IsNullOrEmpty() || phone.Length < 7) return phone;
        return phone.Substring(0, 3) + "****" + phone.Substring(7);
    }
    
    /// <summary>身份证号脱敏</summary>
    public static String MaskIdCard(String idCard)
    {
        if (idCard.IsNullOrEmpty() || idCard.Length < 15) return idCard;
        return idCard.Substring(0, 6) + "********" + idCard.Substring(14);
    }
    
    /// <summary>邮箱脱敏</summary>
    public static String MaskEmail(String email)
    {
        if (email.IsNullOrEmpty() || !email.Contains("@")) return email;
        var parts = email.Split('@');
        var name = parts[0];
        var domain = parts[1];
        var maskedName = name.Length <= 2 
            ? name[0] + "***" 
            : name.Substring(0, 2) + "***";
        return maskedName + "@" + domain;
    }
    
    /// <summary>银行卡号脱敏</summary>
    public static String MaskBankCard(String cardNo)
    {
        if (cardNo.IsNullOrEmpty() || cardNo.Length < 8) return cardNo;
        return cardNo.Substring(0, 4) + " **** **** " + cardNo.Substring(cardNo.Length - 4);
    }
}
```

### 敏感字段加密存储

```csharp
public partial class Customer : Entity<Customer>
{
    /// <summary>手机号（加密存储）</summary>
    [Encrypt]
    public String Phone { get; set; }
    
    /// <summary>身份证号（加密存储）</summary>
    [Encrypt]
    public String IdCard { get; set; }
    
    // 加密处理在实体保存时自动执行
}

// 加密特性
[AttributeUsage(AttributeTargets.Property)]
public class EncryptAttribute : Attribute
{
    public String Algorithm { get; set; } = "AES";
}
```

### 日志脱敏

```csharp
// 记录日志时自动脱敏敏感信息
public void WriteLog(String action, Object data)
{
    var json = data.ToJson();
    
    // 脱敏处理
    json = Regex.Replace(json, @"""phone""\s*:\s*""(\d{3})\d{4}(\d{4})""", 
        @"""phone"":""$1****$2""");
    json = Regex.Replace(json, @"""password""\s*:\s*""[^""]+""", 
        @"""password"":""******""");
    
    Log.Info($"[{action}] {json}");
}
```

---

## 11.6 审计日志

### 操作日志

魔方自动记录所有操作日志：

```csharp
public partial class Log : Entity<Log>
{
    /// <summary>日志ID</summary>
    public Int64 Id { get; set; }
    
    /// <summary>操作类别</summary>
    public String Category { get; set; }
    
    /// <summary>操作行为</summary>
    public String Action { get; set; }
    
    /// <summary>用户ID</summary>
    public Int32 UserId { get; set; }
    
    /// <summary>用户名</summary>
    public String UserName { get; set; }
    
    /// <summary>IP地址</summary>
    public String Ip { get; set; }
    
    /// <summary>操作内容</summary>
    public String Remark { get; set; }
    
    /// <summary>创建时间</summary>
    public DateTime CreateTime { get; set; }
}
```

### 自动日志记录

```csharp
// EntityController 自动记录 CRUD 操作日志
protected override Int32 OnInsert(Product entity)
{
    var count = base.OnInsert(entity);
    
    // 自动记录日志
    LogProvider.Provider.WriteLog(
        typeof(Product).Name,
        "添加",
        true,
        $"添加产品：{entity.Name}"
    );
    
    return count;
}
```

### 登录日志

```csharp
public void RecordLoginLog(User user, Boolean success, String message)
{
    var log = new LoginLog
    {
        UserId = user?.Id ?? 0,
        UserName = user?.Name ?? "Unknown",
        Ip = WebHelper.UserHost,
        Success = success,
        Message = message,
        CreateTime = DateTime.Now
    };
    log.Insert();
}
```

### 日志查询与分析

```csharp
// 查询用户操作日志
public IEnumerable<Log> GetUserLogs(Int32 userId, DateTime start, DateTime end)
{
    var exp = Log._.UserId == userId & 
              Log._.CreateTime >= start & 
              Log._.CreateTime < end;
    
    return Log.FindAll(exp, Log._.Id.Desc(), null, 0, 1000);
}

// 统计操作行为
public IDictionary<String, Int32> GetActionStats(DateTime date)
{
    var start = date.Date;
    var end = start.AddDays(1);
    
    return Log.FindAll(Log._.CreateTime >= start & Log._.CreateTime < end)
        .GroupBy(e => e.Action)
        .ToDictionary(g => g.Key, g => g.Count());
}
```

---

## 11.7 三级等保认证要点

### 等保要求概述

三级等保（信息安全等级保护三级）对系统安全提出以下要求：

| 类别 | 要求 | 魔方支持 |
|------|------|---------|
| 身份鉴别 | 双因素认证、密码策略 | ? |
| 访问控制 | 权限最小化、职责分离 | ? |
| 安全审计 | 操作日志、登录日志 | ? |
| 数据完整性 | 数据校验、备份恢复 | ? |
| 数据保密性 | 加密传输、加密存储 | ? |

### 身份鉴别增强

```csharp
// 双因素认证
public class TwoFactorAuth
{
    public String GenerateCode(User user)
    {
        // 生成6位验证码
        var code = Rand.Next(100000, 999999).ToString();
        
        // 存储验证码（5分钟有效）
        _cache.Set($"2fa:{user.Id}", code, 300);
        
        // 发送短信/邮件
        SendVerificationCode(user, code);
        
        return code;
    }
    
    public Boolean VerifyCode(User user, String code)
    {
        var stored = _cache.Get<String>($"2fa:{user.Id}");
        if (stored == code)
        {
            _cache.Remove($"2fa:{user.Id}");
            return true;
        }
        return false;
    }
}
```

### 会话安全

```csharp
// 会话超时配置
services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.Cookie.SameSite = SameSiteMode.Strict;
});

// 并发会话限制
public Boolean CheckConcurrentSession(User user)
{
    var sessions = UserOnline.FindAllByUserId(user.Id);
    if (sessions.Count >= MaxConcurrentSessions)
    {
        // 踢出最早的会话
        var oldest = sessions.OrderBy(s => s.CreateTime).First();
        oldest.Delete();
    }
    return true;
}
```

### 安全配置清单

```csharp
// CubeSetting 安全相关配置
public class CubeSetting
{
    // 密码策略
    public Int32 PasswordMinLength { get; set; } = 8;
    public Boolean PasswordRequireComplexity { get; set; } = true;
    public Int32 PasswordExpireDays { get; set; } = 90;
    
    // 登录限制
    public Int32 LoginMaxAttempts { get; set; } = 5;
    public Int32 LoginLockMinutes { get; set; } = 30;
    
    // 会话管理
    public Int32 SessionTimeout { get; set; } = 30;
    public Int32 MaxConcurrentSessions { get; set; } = 3;
    
    // 审计日志
    public Boolean EnableAuditLog { get; set; } = true;
    public Int32 LogRetentionDays { get; set; } = 180;
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **HTTPS 配置**：加密数据传输
2. **密码策略**：密码强度和过期管理
3. **登录限制**：防止暴力破解
4. **敏感数据保护**：脱敏和加密
5. **审计日志**：操作追溯
6. **等保要点**：安全合规要求

**下一步**：

- 学习 [用户认证](用户认证.md) 了解认证机制
- 了解 [OAuth 与 SSO](OAuth与SSO.md) 的单点登录

---

## 参考资源

- [魔方的安全与审计](https://newlifex.com/cube/cube_security)
