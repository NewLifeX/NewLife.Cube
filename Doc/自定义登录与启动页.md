# 第19章 自定义登录与启动页

> 本章介绍如何自定义魔方的登录页和系统启动页。
> 
> 详细教程：https://newlifex.com/cube/login

---

## 19.1 自定义登录页

### 登录页结构

默认登录页位于 `Areas/Admin/Views/User/Login.cshtml`。

### 完全自定义登录页

```html
@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登录 - 魔方管理系统</title>
    <link rel="stylesheet" href="~/lib/bootstrap/css/bootstrap.min.css" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            width: 400px;
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-logo img {
            width: 80px;
            height: 80px;
        }
        .login-logo h1 {
            font-size: 24px;
            margin-top: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="login-box">
        <div class="login-logo">
            <img src="~/images/logo.png" alt="Logo" />
            <h1>魔方管理系统</h1>
        </div>
        
        <form action="Login" method="post" id="loginForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="returnUrl" value="@ViewBag.ReturnUrl" />
            
            <div class="form-group">
                <label>用户名</label>
                <input type="text" name="username" class="form-control" 
                       placeholder="请输入用户名" required autofocus />
            </div>
            
            <div class="form-group">
                <label>密码</label>
                <input type="password" name="password" class="form-control"
                       placeholder="请输入密码" required />
            </div>
            
            <div class="form-group">
                <label>验证码</label>
                <div class="input-group">
                    <input type="text" name="captcha" class="form-control"
                           placeholder="请输入验证码" required />
                    <span class="input-group-addon" style="padding:0;">
                        <img src="/Captcha" onclick="this.src='/Captcha?t='+Date.now()"
                             style="height:34px;cursor:pointer;" title="点击刷新" />
                    </span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-inline">
                    <input type="checkbox" name="remember" value="true" /> 记住我
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block">登 录</button>
        </form>
        
        <!-- 第三方登录 -->
        @if (ViewBag.OAuthEnabled)
        {
            <div class="social-auth-links text-center mt-4">
                <p>- 或使用第三方账号登录 -</p>
                @foreach (var provider in ViewBag.OAuthProviders)
                {
                    <a href="/Sso/Login?provider=@provider" class="btn btn-outline-secondary">
                        <i class="fab fa-@provider.ToLower()"></i> @provider
                    </a>
                }
            </div>
        }
    </div>
    
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script>
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            $.post(this.action, $(this).serialize(), function(res) {
                if (res.code === 0) {
                    location.href = res.url || '/';
                } else {
                    alert(res.msg);
                }
            });
        });
    </script>
</body>
</html>
```

---

## 19.2 自定义启动页（首页）

### 仪表盘首页

创建 `Areas/Admin/Views/Index/Index.cshtml`：

```html
@{
    ViewBag.Title = "仪表盘";
}

<section class="content">
    <!-- 统计卡片 -->
    <div class="row">
        <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>@ViewBag.UserCount</h3>
                    <p>用户总数</p>
                </div>
                <div class="icon"><i class="fa fa-users"></i></div>
                <a href="/Admin/User" class="small-box-footer">
                    查看详情 <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>
        
        <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
                <div class="inner">
                    <h3>@ViewBag.OrderCount</h3>
                    <p>订单总数</p>
                </div>
                <div class="icon"><i class="fa fa-shopping-cart"></i></div>
                <a href="/Admin/Order" class="small-box-footer">
                    查看详情 <i class="fa fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>
        
        <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>@ViewBag.TodayVisit</h3>
                    <p>今日访问</p>
                </div>
                <div class="icon"><i class="fa fa-eye"></i></div>
            </div>
        </div>
        
        <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
                <div class="inner">
                    <h3>@ViewBag.TotalAmount.ToString("N0")</h3>
                    <p>销售总额</p>
                </div>
                <div class="icon"><i class="fa fa-money"></i></div>
            </div>
        </div>
    </div>
    
    <!-- 图表区域 -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">销售趋势</h3>
                </div>
                <div class="card-body">
                    <div id="salesChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">分类占比</h3>
                </div>
                <div class="card-body">
                    <div id="categoryChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/lib/echarts/echarts.min.js"></script>
    <script>
        // 销售趋势图
        var salesChart = echarts.init(document.getElementById('salesChart'));
        salesChart.setOption({
            xAxis: { type: 'category', data: @Html.Raw(ViewBag.Dates.ToJson()) },
            yAxis: { type: 'value' },
            series: [{ data: @Html.Raw(ViewBag.Sales.ToJson()), type: 'line', smooth: true }]
        });
        
        // 分类占比图
        var categoryChart = echarts.init(document.getElementById('categoryChart'));
        categoryChart.setOption({
            series: [{
                type: 'pie',
                data: @Html.Raw(ViewBag.CategoryData.ToJson())
            }]
        });
    </script>
}
```

---

## 19.3 登录后跳转配置

```csharp
// 配置默认首页
public class CubeSetting
{
    /// <summary>登录后默认跳转页面</summary>
    public String DefaultPage { get; set; } = "/Admin";
    
    /// <summary>根据角色跳转不同页面</summary>
    public Dictionary<String, String> RoleHomePage { get; set; } = new()
    {
        ["管理员"] = "/Admin/Index",
        ["编辑员"] = "/Admin/Content",
        ["财务"] = "/Admin/Finance"
    };
}

// 登录成功后的跳转逻辑
public ActionResult Login(String username, String password, String returnUrl)
{
    // ... 验证逻辑
    
    // 确定跳转地址
    var url = returnUrl;
    if (url.IsNullOrEmpty())
    {
        var user = ManageProvider.User as User;
        var setting = CubeSetting.Current;
        
        url = setting.RoleHomePage.GetValueOrDefault(user.RoleName) 
            ?? setting.DefaultPage;
    }
    
    return Json(new { code = 0, url });
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **自定义登录页**：完全覆写登录界面
2. **第三方登录集成**：OAuth 登录按钮
3. **自定义首页**：仪表盘设计
4. **跳转配置**：登录后的页面跳转

---

## 参考资源

- [自定义登录页](https://newlifex.com/cube/login)
