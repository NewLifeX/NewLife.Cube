# 第15章 自定义列表页

> 本章介绍如何自定义魔方的列表页，包括列表结构、数据展示、工具栏和操作按钮。

---

## 15.1 列表页结构分析

### 列表页组成

```
┌─────────────────────────────────────────────────────┐
│                    面包屑导航                        │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ 工具栏（_List_Toolbar）                          │ │
│ │ [添加] [删除] [导出Excel] [自定义按钮...]        │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 搜索区（_List_Search）                          │ │
│ │ 名称: [______] 状态: [] 日期: [___] ~ [___]   │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 数据表格（_List_Data）                          │ │
│ │ ┌───┬──────┬──────┬──────┬──────┬──────┐      │ │
│ │ │ ? │ 名称 │ 编码 │ 价格 │ 状态 │ 操作 │      │ │
│ │ ├───┼──────┼──────┼──────┼──────┼──────┤      │ │
│ │ │ ? │ ...  │ ...  │ ...  │ ...  │ 编辑 │      │ │
│ │ └───┴──────┴──────┴──────┴──────┴──────┘      │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 分页（_List_Pager）                              │ │
│ │ 共 100 条  [上一页] 1 2 3 ... 10 [下一页]        │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 统计行（可选）                                   │ │
│ │ 合计：100 条，总金额：￥99,999.00               │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 15.2 自定义列表视图

### 完全自定义列表页

创建 `Areas/Admin/Views/Product/Index.cshtml`：

```html
@model Pager
@{
    ViewBag.Title = "产品管理";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    
    var page = Model;
    var list = ViewBag.Page as IList<Product>;
}

<section class="content-header">
    <h1>@ViewBag.Title</h1>
</section>

<section class="content">
    <div class="box">
        <div class="box-header">
            <div class="btn-group">
                <a href="Add" class="btn btn-success">
                    <i class="fa fa-plus"></i> 添加产品
                </a>
                <button type="button" class="btn btn-danger" onclick="batchDelete()">
                    <i class="fa fa-trash"></i> 批量删除
                </button>
            </div>
        </div>
        
        <div class="box-body">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="checkAll" /></th>
                        <th>产品名称</th>
                        <th>编码</th>
                        <th>价格</th>
                        <th>库存</th>
                        <th>状态</th>
                        <th width="150">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (Product item in list)
                    {
                        <tr>
                            <td><input type="checkbox" name="keys" value="@item.Id" /></td>
                            <td>@item.Name</td>
                            <td>@item.Code</td>
                            <td class="text-right">@item.Price.ToString("N2")</td>
                            <td class="text-right">@item.Stock</td>
                            <td>
                                @if (item.Enable)
                                {
                                    <span class="label label-success">启用</span>
                                }
                                else
                                {
                                    <span class="label label-default">禁用</span>
                                }
                            </td>
                            <td>
                                <a href="Edit/@item.Id" class="btn btn-xs btn-primary">编辑</a>
                                <a href="Delete/@item.Id" class="btn btn-xs btn-danger" 
                                   onclick="return confirm('确定删除？')">删除</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="box-footer">
            @Html.Partial("_List_Pager", page)
        </div>
    </div>
</section>
```

---

## 15.3 自定义列表数据展示

### 自定义列渲染

在控制器中配置列表字段：

```csharp
static ProductController()
{
    // 自定义价格列显示
    var price = ListFields.GetField("Price") as ListField;
    if (price != null)
    {
        price.DataSource = e =>
        {
            var p = e as Product;
            return $"￥{p.Price:N2}";
        };
        price.Align = "right";
    }
    
    // 自定义状态列显示
    var status = ListFields.GetField("Enable") as ListField;
    if (status != null)
    {
        status.DataSource = e =>
        {
            var p = e as Product;
            return p.Enable 
                ? "<span class='label label-success'>启用</span>" 
                : "<span class='label label-default'>禁用</span>";
        };
        status.Align = "center";
    }
    
    // 添加图片列
    ListFields.AddDataField(new ListField
    {
        Name = "Image",
        DisplayName = "图片",
        DataSource = e =>
        {
            var p = e as Product;
            if (p.ImageUrl.IsNullOrEmpty()) return "";
            return $"<img src='{p.ImageUrl}' style='width:50px;height:50px;' />";
        }
    });
}
```

### 条件样式

根据数据条件设置行样式：

```html
@foreach (Product item in list)
{
    var rowClass = "";
    if (item.Stock <= 0) rowClass = "danger";
    else if (item.Stock < 10) rowClass = "warning";
    
    <tr class="@rowClass">
        <!-- 列内容 -->
    </tr>
}
```

---

## 15.4 自定义列表工具栏

### 覆写 _List_Toolbar

创建 `Areas/Admin/Views/Product/_List_Toolbar.cshtml`：

```html
@{
    var menu = ViewBag.Menu as Menu;
    var user = ManageProvider.User as IUser;
}

<div class="box-header with-border">
    <div class="btn-group">
        @if (user.Has(menu, PermissionFlags.Insert))
        {
            <a href="Add" class="btn btn-success">
                <i class="fa fa-plus"></i> 添加
            </a>
        }
        
        @if (user.Has(menu, PermissionFlags.Delete))
        {
            <button type="button" class="btn btn-danger" onclick="batchDelete()">
                <i class="fa fa-trash"></i> 批量删除
            </button>
        }
        
        <!-- 自定义按钮 -->
        <div class="btn-group">
            <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-download"></i> 导出 <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="ExportExcel">导出 Excel</a></li>
                <li><a href="ExportCsv">导出 CSV</a></li>
                <li><a href="ExportPdf">导出 PDF</a></li>
            </ul>
        </div>
        
        <a href="Import" class="btn btn-warning">
            <i class="fa fa-upload"></i> 导入
        </a>
    </div>
    
    <div class="box-tools pull-right">
        <button type="button" class="btn btn-default btn-sm" onclick="refreshList()">
            <i class="fa fa-refresh"></i>
        </button>
    </div>
</div>
```

---

## 15.5 自定义列表操作按钮

### 行内操作按钮

```csharp
static ProductController()
{
    // 添加行内按钮
    ListFields.AddDataField(new LinkField
    {
        Name = "Actions",
        DisplayName = "操作",
        DataSource = e =>
        {
            var p = e as Product;
            var sb = new StringBuilder();
            
            // 编辑按钮
            sb.Append($"<a href='Edit/{p.Id}' class='btn btn-xs btn-primary'>编辑</a> ");
            
            // 复制按钮
            sb.Append($"<a href='Copy/{p.Id}' class='btn btn-xs btn-info'>复制</a> ");
            
            // 根据状态显示不同按钮
            if (p.Enable)
                sb.Append($"<a href='Disable/{p.Id}' class='btn btn-xs btn-warning'>禁用</a> ");
            else
                sb.Append($"<a href='Enable/{p.Id}' class='btn btn-xs btn-success'>启用</a> ");
            
            // 删除按钮
            sb.Append($"<a href='Delete/{p.Id}' class='btn btn-xs btn-danger' onclick=\"return confirm('确定删除？')\">删除</a>");
            
            return sb.ToString();
        }
    });
}
```

### 下拉操作菜单

```html
<td>
    <div class="btn-group">
        <button type="button" class="btn btn-xs btn-default dropdown-toggle" 
                data-toggle="dropdown">
            操作 <span class="caret"></span>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
            <li><a href="Edit/@item.Id"><i class="fa fa-edit"></i> 编辑</a></li>
            <li><a href="Detail/@item.Id"><i class="fa fa-eye"></i> 查看</a></li>
            <li><a href="Copy/@item.Id"><i class="fa fa-copy"></i> 复制</a></li>
            <li class="divider"></li>
            <li><a href="Delete/@item.Id" onclick="return confirm('确定删除？')">
                <i class="fa fa-trash"></i> 删除
            </a></li>
        </ul>
    </div>
</td>
```

---

## 15.6 列表页配置项

### 分页大小

```csharp
// 控制器中设置默认分页大小
protected override Pager NewPager()
{
    return new Pager
    {
        PageSize = 20,      // 每页20条
        PageSizes = "10,20,50,100"  // 可选分页大小
    };
}
```

### 表格样式

```html
<!-- 基础表格 -->
<table class="table">

<!-- 带边框 -->
<table class="table table-bordered">

<!-- 悬停高亮 -->
<table class="table table-hover">

<!-- 斑马纹 -->
<table class="table table-striped">

<!-- 紧凑型 -->
<table class="table table-condensed">

<!-- 组合使用 -->
<table class="table table-bordered table-striped table-hover">
```

### 固定表头

```html
<div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
    <table class="table table-bordered">
        <thead style="position: sticky; top: 0; background: white;">
            <tr>
                <th>名称</th>
                <!-- ... -->
            </tr>
        </thead>
        <tbody>
            <!-- 数据行 -->
        </tbody>
    </table>
</div>
```

---

## 列表页高级功能

### 列排序

```csharp
// 控制器中处理排序
protected override IEnumerable<Product> Search(Pager p)
{
    // 获取排序参数
    var sort = p.Sort;
    var desc = p.Desc;
    
    var order = sort.IsNullOrEmpty() ? null : 
                desc ? Product._.GetField(sort).Desc() : 
                       Product._.GetField(sort).Asc();
    
    return Product.Search(p["name"], order, p);
}
```

```html
<!-- 可排序的列头 -->
<th>
    <a href="?sort=Name&desc=@(!ViewBag.Desc)">
        名称 
        @if (ViewBag.Sort == "Name")
        {
            <i class="fa fa-sort-@(ViewBag.Desc ? "desc" : "asc")"></i>
        }
    </a>
</th>
```

### 列宽调整

```html
<colgroup>
    <col style="width: 40px;" />  <!-- 复选框 -->
    <col style="width: 200px;" /> <!-- 名称 -->
    <col style="width: 100px;" /> <!-- 编码 -->
    <col style="width: auto;" />  <!-- 描述（自适应） -->
    <col style="width: 150px;" /> <!-- 操作 -->
</colgroup>
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **列表页结构**：工具栏、搜索区、数据表格、分页
2. **自定义视图**：完全覆写或部分覆写
3. **数据展示**：自定义列渲染和条件样式
4. **工具栏定制**：添加自定义按钮
5. **操作按钮**：行内按钮和下拉菜单

**下一步**：

- 学习 [自定义查询](自定义查询.md) 了解搜索功能定制
- 了解 [自定义表单页](自定义表单页.md) 的表单定制

---
