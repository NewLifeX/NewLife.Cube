# 第7章 菜单系统

> 本章介绍魔方的菜单系统，包括菜单的自动注册、手动配置、图标设置和可见性控制。
> 
> 菜单是用户访问系统功能的入口，合理的菜单结构可以提升用户体验。

---

## 7.1 菜单树接口 GetMenuTree

### 菜单树结构

魔方的菜单采用树形结构组织：

```
根菜单
├── 系统管理
│   ├── 用户管理
│   ├── 角色管理
│   └── 菜单管理
├── 日志管理
│   ├── 操作日志
│   └── 访问日志
└── 业务管理
    ├── 产品管理
    └── 订单管理
```

### 获取菜单树

```csharp
// 获取当前用户可见的菜单树
var menus = Menu.GetMyMenu();

// 获取所有菜单
var allMenus = Menu.FindAllWithCache();

// 获取指定父菜单下的子菜单
var children = Menu.FindAllByParentId(parentId);
```

### 菜单实体属性

| 属性 | 类型 | 说明 |
|------|------|------|
| Id | Int32 | 菜单ID |
| Name | String | 菜单名称 |
| DisplayName | String | 显示名称 |
| ParentId | Int32 | 父菜单ID |
| Url | String | 链接地址 |
| Icon | String | 图标类名 |
| Sort | Int32 | 排序序号 |
| Visible | Boolean | 是否可见 |
| Enable | Boolean | 是否启用 |
| Permission | String | 权限标识 |

---

## 7.2 菜单自动注册

### 控制器自动扫描

魔方在启动时自动扫描所有控制器，并注册菜单：

```csharp
// 使用 Menu 特性标记控制器
[Menu("产品管理", Icon = "fa-box")]
[AdminArea]
public class ProductController : EntityController<Product>
{
}
```

### MenuAttribute 特性

```csharp
[AttributeUsage(AttributeTargets.Class, AllowMultiple = false)]
public class MenuAttribute : Attribute
{
    /// <summary>菜单名称</summary>
    public String Name { get; set; }
    
    /// <summary>图标</summary>
    public String Icon { get; set; }
    
    /// <summary>排序</summary>
    public Int32 Order { get; set; }
    
    /// <summary>父菜单名称</summary>
    public String Parent { get; set; }
    
    /// <summary>是否可见</summary>
    public Boolean Visible { get; set; } = true;
}
```

### 自动注册规则

1. **扫描所有 Area 下的控制器**
2. **读取 Menu 特性配置**
3. **根据 Area 名称创建父菜单**
4. **按 Order 排序**

```csharp
// 示例：Admin 区域下的控制器
namespace MyApp.Areas.Admin.Controllers
{
    [Menu("产品管理", Order = 10)]
    public class ProductController : EntityController<Product>
    {
        // 自动注册到 "Admin" 父菜单下
        // 菜单名称：产品管理
        // 排序：10
    }
}
```

---

## 7.3 菜单手动配置

### 通过代码配置

在应用启动时手动注册菜单：

```csharp
public class Startup
{
    public void Configure(IApplicationBuilder app)
    {
        // 注册菜单
        RegisterMenus();
    }
    
    private void RegisterMenus()
    {
        // 创建父菜单
        var parent = Menu.FindByName("业务管理");
        if (parent == null)
        {
            parent = new Menu
            {
                Name = "业务管理",
                DisplayName = "业务管理",
                Icon = "fa-briefcase",
                Sort = 100,
                Visible = true
            };
            parent.Insert();
        }
        
        // 创建子菜单
        var menu = Menu.FindByName("产品管理");
        if (menu == null)
        {
            menu = new Menu
            {
                Name = "产品管理",
                DisplayName = "产品管理",
                ParentId = parent.Id,
                Url = "/Admin/Product",
                Icon = "fa-box",
                Sort = 10,
                Visible = true
            };
            menu.Insert();
        }
    }
}
```

### 通过数据库配置

直接在数据库中管理菜单：

```sql
-- 插入父菜单
INSERT INTO Menu (Name, DisplayName, ParentId, Icon, Sort, Visible)
VALUES ('业务管理', '业务管理', 0, 'fa-briefcase', 100, 1);

-- 插入子菜单
INSERT INTO Menu (Name, DisplayName, ParentId, Url, Icon, Sort, Visible)
VALUES ('产品管理', '产品管理', @ParentId, '/Admin/Product', 'fa-box', 10, 1);
```

### 菜单权限配置

为菜单配置访问权限：

```csharp
// 获取菜单
var menu = Menu.FindByName("产品管理");

// 设置权限
menu.Permission = "ProductController";  // 关联控制器

// 配置角色权限
var role = Role.FindByName("管理员");
role.Set(menu.Id, PermissionFlags.All);  // 赋予所有权限
role.Update();
```

---

## 7.4 菜单图标与排序

### 图标配置

魔方支持多种图标库：

```csharp
// Font Awesome 图标
[Menu("用户管理", Icon = "fa-users")]

// Bootstrap Icons
[Menu("设置", Icon = "bi-gear")]

// 自定义图标类
[Menu("首页", Icon = "icon-home")]
```

**常用图标**：

| 功能 | Font Awesome | 说明 |
|------|--------------|------|
| 首页 | fa-home | 仪表盘/首页 |
| 用户 | fa-user / fa-users | 用户管理 |
| 设置 | fa-cog / fa-cogs | 系统设置 |
| 日志 | fa-file-text | 日志查看 |
| 统计 | fa-bar-chart | 数据统计 |
| 订单 | fa-shopping-cart | 订单管理 |
| 产品 | fa-box / fa-cube | 产品管理 |

### 排序配置

```csharp
// 通过特性配置排序
[Menu("产品管理", Order = 10)]
[Menu("订单管理", Order = 20)]
[Menu("用户管理", Order = 30)]

// 通过代码调整排序
var menu = Menu.FindByName("产品管理");
menu.Sort = 5;  // 数值越小越靠前
menu.Update();
```

### 批量调整排序

```csharp
// 获取同级菜单
var menus = Menu.FindAllByParentId(parentId)
    .OrderBy(m => m.Sort)
    .ToList();

// 重新排序
for (int i = 0; i < menus.Count; i++)
{
    menus[i].Sort = (i + 1) * 10;
    menus[i].Update();
}
```

---

## 7.5 菜单可见性控制

### 基于角色的可见性

```csharp
// 检查当前用户是否有菜单访问权限
var menu = Menu.FindByName("产品管理");
var user = ManageProvider.User as IUser;

if (user.Has(menu, PermissionFlags.Detail))
{
    // 用户有访问权限，显示菜单
}
```

### 隐藏菜单

```csharp
// 隐藏菜单（不在导航中显示，但可以直接访问）
[Menu("内部工具", Visible = false)]
public class InternalToolController : EntityController<Tool>
{
}

// 通过代码隐藏
var menu = Menu.FindByName("内部工具");
menu.Visible = false;
menu.Update();
```

### 条件性显示

```csharp
// 根据配置决定是否显示
protected override Boolean GetMenuVisible(Menu menu)
{
    // 只在开发环境显示调试菜单
    if (menu.Name == "调试工具")
        return Runtime.IsDebug;
    
    // 只对特定租户显示
    if (menu.Name == "高级功能")
        return CurrentTenant?.Level >= 2;
    
    return base.GetMenuVisible(menu);
}
```

### 动态菜单

```csharp
// 根据业务数据动态生成菜单
public List<Menu> GetDynamicMenus()
{
    var menus = new List<Menu>();
    
    // 获取用户有权限的项目
    var projects = Project.FindAllByUserId(CurrentUser.Id);
    
    foreach (var project in projects)
    {
        menus.Add(new Menu
        {
            Name = $"Project_{project.Id}",
            DisplayName = project.Name,
            Url = $"/Project/Detail/{project.Id}",
            Icon = "fa-folder"
        });
    }
    
    return menus;
}
```

---

## 菜单最佳实践

### 1. 菜单层级建议

```
推荐：最多3级菜单
├── 一级菜单（功能模块）
│   ├── 二级菜单（具体功能）
│   │   └── 三级菜单（子功能）[可选]
```

### 2. 命名规范

| 类型 | 建议 | 示例 |
|------|------|------|
| 模块菜单 | 名词 | 用户管理、订单管理 |
| 功能菜单 | 动词+名词 | 用户列表、添加用户 |
| 工具菜单 | 简洁明了 | 导入、导出、设置 |

### 3. 图标一致性

同一层级的菜单图标风格应保持一致：

```csharp
// 好的做法：同一系列图标
[Menu("用户", Icon = "fa-user")]
[Menu("角色", Icon = "fa-users")]
[Menu("权限", Icon = "fa-lock")]

// 避免：图标风格混乱
[Menu("用户", Icon = "fa-user")]
[Menu("角色", Icon = "bi-people")]  // 混用图标库
```

### 4. 性能优化

```csharp
// 使用缓存获取菜单
var menus = Menu.FindAllWithCache();

// 避免在循环中查询菜单
foreach (var item in list)
{
    // 不好：每次循环都查询
    // var menu = Menu.FindByName(item.MenuName);
    
    // 好：使用缓存字典
    var menu = menuDict.GetValueOrDefault(item.MenuName);
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **菜单树结构**：理解菜单的层级组织方式
2. **自动注册**：使用 MenuAttribute 特性自动注册菜单
3. **手动配置**：通过代码或数据库手动管理菜单
4. **图标与排序**：配置菜单图标和显示顺序
5. **可见性控制**：根据权限和条件控制菜单显示

**下一步**：

- 学习 [权限系统](权限系统.md) 了解菜单权限控制
- 了解 [视图体系](视图体系.md) 的导航栏定制

---

## 参考资源

- [魔方功能特点与最佳实践](https://newlifex.com/cube/feature)
- [角色菜单与权限控制](https://newlifex.com/cube/permission)
