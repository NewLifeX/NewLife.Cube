# 第17章 自定义表单页

> 本章介绍如何自定义魔方的表单页，包括添加表单、编辑表单和表单验证。
> 
> 详细教程：https://newlifex.com/cube/form

---

## 17.1 表单页结构分析

### 表单页组成

```
┌─────────────────────────────────────────────────────┐
│                    面包屑导航                        │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ 表单头部（_Form_Header）                         │ │
│ │ 添加产品 / 编辑产品                              │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 表单主体（_Form_Body）                          │ │
│ │ ┌─────────────────────────────────────────────┐ │ │
│ │ │ 产品名称: [________________________]  *必填  │ │ │
│ │ ├─────────────────────────────────────────────┤ │ │
│ │ │ 产品编码: [________________________]        │ │ │
│ │ ├─────────────────────────────────────────────┤ │ │
│ │ │ 分    类: [ 请选择分类 ]                  │ │ │
│ │ ├─────────────────────────────────────────────┤ │ │
│ │ │ 价    格: [____________] 元                 │ │ │
│ │ ├─────────────────────────────────────────────┤ │ │
│ │ │ 描    述: [                              ]  │ │ │
│ │ │           [                              ]  │ │ │
│ │ └─────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 表单底部（_Form_Footer）                         │ │
│ │          [保存]  [保存并继续]  [返回]            │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 17.2 表单字段配置

### 在控制器中配置表单字段

```csharp
static ProductController()
{
    // 添加表单字段配置
    var addFields = AddFormFields;
    
    // 隐藏自动字段
    addFields.RemoveField("Id", "CreateTime", "UpdateTime", "CreateUser", "UpdateUser");
    
    // 名称字段
    var name = addFields.GetField("Name") as FormField;
    name.Required = true;
    name.Placeholder = "请输入产品名称";
    name.MaxLength = 100;
    
    // 编码字段
    var code = addFields.GetField("Code") as FormField;
    code.Placeholder = "留空自动生成";
    
    // 分类字段（下拉选择）
    var category = addFields.GetField("CategoryId") as FormField;
    category.Type = "select";
    category.DataSource = e => Category.FindAllWithCache()
        .ToDictionary(c => c.Id.ToString(), c => c.Name);
    
    // 价格字段
    var price = addFields.GetField("Price") as FormField;
    price.Type = "number";
    price.Min = 0;
    price.Step = "0.01";
    
    // 描述字段（多行文本）
    var desc = addFields.GetField("Description") as FormField;
    desc.Type = "textarea";
    desc.Rows = 5;
    
    // 编辑表单额外配置
    var editFields = EditFormFields;
    
    // 编码只读（编辑时不能修改）
    var editCode = editFields.GetField("Code") as FormField;
    editCode.ReadOnly = true;
}
```

---

## 17.3 AddFormFields / EditFormFields

### 区分添加和编辑表单

```csharp
static ProductController()
{
    // 添加表单：显示基础字段
    AddFormFields.RemoveField("Id", "CreateTime", "UpdateTime");
    
    // 编辑表单：显示更多字段
    EditFormFields.AddFormField("CreateTime");
    EditFormFields.AddFormField("UpdateTime");
    
    // 编辑表单：某些字段只读
    var idField = EditFormFields.GetField("Id") as FormField;
    if (idField != null) idField.ReadOnly = true;
}
```

### 动态表单字段

```csharp
protected override FieldCollection GetFields(String kind)
{
    var fields = base.GetFields(kind);
    
    if (kind == "AddForm" || kind == "EditForm")
    {
        var user = ManageProvider.User as User;
        
        // 非管理员隐藏敏感字段
        if (!user.IsAdmin)
        {
            fields.RemoveField("Cost", "Margin");
        }
        
        // 根据角色显示不同字段
        if (user.RoleName == "财务")
        {
            fields.AddFormField("FinanceNote");
        }
    }
    
    return fields;
}
```

---

## 17.4 表单验证（客户端 / 服务端）

### 客户端验证

```html
<form id="editForm" action="Update" method="post">
    <div class="form-group">
        <label>产品名称 <span class="text-danger">*</span></label>
        <input type="text" name="Name" class="form-control" 
               required minlength="2" maxlength="100"
               data-msg-required="请输入产品名称"
               data-msg-minlength="名称至少2个字符" />
    </div>
    
    <div class="form-group">
        <label>价格</label>
        <input type="number" name="Price" class="form-control"
               min="0" max="999999" step="0.01"
               data-msg-min="价格不能为负数" />
    </div>
    
    <div class="form-group">
        <label>邮箱</label>
        <input type="email" name="Email" class="form-control"
               pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
               data-msg-email="请输入有效的邮箱地址" />
    </div>
</form>

@section Scripts {
    <script src="~/lib/jquery-validation/jquery.validate.min.js"></script>
    <script>
        $('#editForm').validate({
            errorClass: 'text-danger',
            errorElement: 'span',
            highlight: function(element) {
                $(element).addClass('is-invalid');
            },
            unhighlight: function(element) {
                $(element).removeClass('is-invalid');
            }
        });
    </script>
}
```

### 服务端验证（Valid 方法）

```csharp
protected override Boolean Valid(Product entity, DataObjectMethodType type, Boolean post)
{
    if (post)
    {
        // 必填验证
        if (entity.Name.IsNullOrEmpty())
            throw new ArgumentNullException(nameof(entity.Name), "产品名称不能为空");
        
        // 长度验证
        if (entity.Name.Length < 2 || entity.Name.Length > 100)
            throw new ArgumentException("产品名称长度必须在2-100个字符之间");
        
        // 范围验证
        if (entity.Price < 0)
            throw new ArgumentException("价格不能为负数");
        
        // 唯一性验证
        if (type == DataObjectMethodType.Insert)
        {
            var exist = Product.FindByCode(entity.Code);
            if (exist != null)
                throw new ArgumentException($"编码 {entity.Code} 已存在");
        }
        
        // 关联验证
        if (entity.CategoryId > 0)
        {
            var category = Category.FindById(entity.CategoryId);
            if (category == null)
                throw new ArgumentException("所选分类不存在");
        }
        
        // 自定义业务规则验证
        if (entity.Price > entity.MaxPrice)
            throw new ArgumentException("价格不能超过最高限价");
    }
    
    return base.Valid(entity, type, post);
}
```

---

## 17.5 自定义表单控件

### 下拉选择

```csharp
// 控制器配置
var field = AddFormFields.GetField("CategoryId") as FormField;
field.Type = "select";
field.DataSource = e => Category.FindAllWithCache()
    .Where(c => c.Enable)
    .ToDictionary(c => c.Id.ToString(), c => c.Name);
```

```html
<!-- 视图渲染 -->
<select name="CategoryId" class="form-control">
    <option value="">请选择分类</option>
    @foreach (var item in ViewBag.Categories)
    {
        var selected = Model.CategoryId == item.Id ? "selected" : "";
        <option value="@item.Id" @selected>@item.Name</option>
    }
</select>
```

### 单选 / 多选

```html
<!-- 单选按钮 -->
<div class="form-group">
    <label>状态</label>
    <div>
        <label class="radio-inline">
            <input type="radio" name="Status" value="1" 
                   @(Model.Status == 1 ? "checked" : "") /> 启用
        </label>
        <label class="radio-inline">
            <input type="radio" name="Status" value="0"
                   @(Model.Status == 0 ? "checked" : "") /> 禁用
        </label>
    </div>
</div>

<!-- 多选复选框 -->
<div class="form-group">
    <label>标签</label>
    <div>
        @foreach (var tag in ViewBag.Tags)
        {
            var isChecked = Model.TagIds?.Contains(tag.Id.ToString()) ?? false;
            <label class="checkbox-inline">
                <input type="checkbox" name="TagIds" value="@tag.Id"
                       @(isChecked ? "checked" : "") /> @tag.Name
            </label>
        }
    </div>
</div>
```

### 文件上传

```html
<div class="form-group">
    <label>产品图片</label>
    <input type="file" name="ImageFile" class="form-control" 
           accept="image/*" />
    @if (!Model.ImageUrl.IsNullOrEmpty())
    {
        <div class="mt-2">
            <img src="@Model.ImageUrl" style="max-width:200px;" />
            <input type="hidden" name="ImageUrl" value="@Model.ImageUrl" />
        </div>
    }
</div>
```

### 富文本编辑器

```html
<div class="form-group">
    <label>产品详情</label>
    <textarea name="Content" id="editor">@Model.Content</textarea>
</div>

@section Scripts {
    <script src="~/lib/ckeditor/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('editor', {
            height: 300,
            filebrowserUploadUrl: '/Upload/CKEditor'
        });
    </script>
}
```

### 日期时间选择器

```html
<div class="form-group">
    <label>上架时间</label>
    <input type="datetime-local" name="PublishTime" class="form-control"
           value="@Model.PublishTime?.ToString("yyyy-MM-ddTHH:mm")" />
</div>
```

---

## 17.6 自定义表单视图

### 完全自定义表单

创建 `Areas/Admin/Views/Product/Form.cshtml`：

```html
@model Product
@{
    ViewBag.Title = Model.Id > 0 ? "编辑产品" : "添加产品";
    var action = Model.Id > 0 ? "Update" : "Insert";
}

<section class="content-header">
    <h1>@ViewBag.Title</h1>
</section>

<section class="content">
    <div class="box box-primary">
        <form action="@action" method="post" enctype="multipart/form-data" id="mainForm">
            @Html.AntiForgeryToken()
            
            @if (Model.Id > 0)
            {
                <input type="hidden" name="Id" value="@Model.Id" />
            }
            
            <div class="box-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>产品名称 <span class="text-danger">*</span></label>
                            <input type="text" name="Name" value="@Model.Name" 
                                   class="form-control" required />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>产品编码</label>
                            <input type="text" name="Code" value="@Model.Code"
                                   class="form-control" @(Model.Id > 0 ? "readonly" : "") />
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>分类</label>
                            <select name="CategoryId" class="form-control">
                                <option value="">请选择</option>
                                @foreach (var cat in ViewBag.Categories)
                                {
                                    <option value="@cat.Id" @(Model.CategoryId == cat.Id ? "selected" : "")>
                                        @cat.Name
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>价格</label>
                            <div class="input-group">
                                <span class="input-group-addon">￥</span>
                                <input type="number" name="Price" value="@Model.Price"
                                       class="form-control" min="0" step="0.01" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>库存</label>
                            <input type="number" name="Stock" value="@Model.Stock"
                                   class="form-control" min="0" />
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>产品描述</label>
                    <textarea name="Description" class="form-control" rows="5">@Model.Description</textarea>
                </div>
            </div>
            
            <div class="box-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-save"></i> 保存
                </button>
                <button type="submit" name="__next" value="Add" class="btn btn-success">
                    <i class="fa fa-plus"></i> 保存并新增
                </button>
                <a href="Index" class="btn btn-default">
                    <i class="fa fa-arrow-left"></i> 返回
                </a>
            </div>
        </form>
    </div>
</section>
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **表单结构**：头部、主体、底部组成
2. **字段配置**：AddFormFields / EditFormFields
3. **表单验证**：客户端和服务端验证
4. **自定义控件**：下拉、单选、多选、上传、富文本
5. **自定义视图**：完全覆写表单页

**下一步**：

- 学习 [自定义导航与布局](自定义导航与布局.md)
- 了解 [自定义登录与启动页](自定义登录与启动页.md)

---

## 参考资源

- [自定义表单页](https://newlifex.com/cube/form)
