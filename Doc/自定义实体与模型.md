# 第34章 自定义实体与模型

> 本章介绍如何在魔方中自定义实体和模型，包括 IModel 接口、Model 层设计、实体与模型映射等内容。

---

## 34.1 IModel 接口

### 接口定义

`IModel` 是魔方定义的通用数据模型接口，支持动态属性访问：

```csharp
/// <summary>数据模型接口</summary>
public interface IModel
{
    /// <summary>索引器，通过属性名访问数据</summary>
    /// <param name="name">属性名</param>
    /// <returns>属性值</returns>
    Object this[String name] { get; set; }
}
```

### 实现示例

```csharp
/// <summary>学生模型</summary>
public class StudentModel : IModel
{
    /// <summary>编号</summary>
    public Int32 Id { get; set; }
    
    /// <summary>姓名</summary>
    public String Name { get; set; }
    
    /// <summary>班级编号</summary>
    public Int32 ClassId { get; set; }
    
    /// <summary>年龄</summary>
    public Int32 Age { get; set; }
    
    /// <summary>索引器实现</summary>
    public Object this[String name]
    {
        get => this.GetValue(name);
        set => this.SetValue(name, value);
    }
}
```

### 扩展方法

```csharp
/// <summary>模型扩展</summary>
public static class ModelExtensions
{
    /// <summary>获取属性值</summary>
    public static Object GetValue(this Object obj, String name)
    {
        var pi = obj.GetType().GetProperty(name);
        return pi?.GetValue(obj);
    }
    
    /// <summary>设置属性值</summary>
    public static void SetValue(this Object obj, String name, Object value)
    {
        var pi = obj.GetType().GetProperty(name);
        if (pi != null && pi.CanWrite)
        {
            var v = value.ChangeType(pi.PropertyType);
            pi.SetValue(obj, v);
        }
    }
}
```

---

## 34.2 Model 层设计

### 分层架构

```
├── MyApp.Web              # Web层（Controller、View）
├── MyApp.Service          # 服务层（业务逻辑）
├── MyApp.Models           # 模型层（DTO、ViewModel）
└── MyApp.Data             # 数据层（实体、仓储）
```

### 模型类型

| 类型 | 用途 | 示例 |
|------|------|------|
| **Entity** | 数据库映射实体 | `Student : Entity<Student>` |
| **DTO** | 数据传输对象 | `StudentDto` |
| **ViewModel** | 视图模型 | `StudentViewModel` |
| **InputModel** | 输入模型 | `StudentCreateInput` |
| **OutputModel** | 输出模型 | `StudentDetailOutput` |

### 示例：完整的模型设计

```csharp
// 实体类（数据层）
public partial class Student : Entity<Student>
{
    public Int32 Id { get; set; }
    public String Name { get; set; }
    public Int32 ClassId { get; set; }
    public DateTime Birthday { get; set; }
    public String Remark { get; set; }
    
    // 导航属性
    public Class Class => Extends.Get(nameof(Class), k => Class.FindById(ClassId));
}

// 输入模型
public class StudentInput : IModel
{
    [Required(ErrorMessage = "姓名不能为空")]
    [StringLength(50, ErrorMessage = "姓名最长50个字符")]
    public String Name { get; set; }
    
    [Range(1, 100, ErrorMessage = "请选择班级")]
    public Int32 ClassId { get; set; }
    
    public DateTime? Birthday { get; set; }
    
    public String Remark { get; set; }
    
    public Object this[String name]
    {
        get => this.GetValue(name);
        set => this.SetValue(name, value);
    }
}

// 输出模型
public class StudentOutput
{
    public Int32 Id { get; set; }
    public String Name { get; set; }
    public Int32 ClassId { get; set; }
    public String ClassName { get; set; }
    public DateTime Birthday { get; set; }
    public Int32 Age { get; set; }
}

// 列表项模型
public class StudentListItem
{
    public Int32 Id { get; set; }
    public String Name { get; set; }
    public String ClassName { get; set; }
    public Int32 Age { get; set; }
}
```

---

## 34.3 实体与模型映射

### 手动映射

```csharp
/// <summary>实体映射扩展</summary>
public static class StudentMapper
{
    /// <summary>实体转输出模型</summary>
    public static StudentOutput ToOutput(this Student entity)
    {
        if (entity == null) return null;
        
        return new StudentOutput
        {
            Id = entity.Id,
            Name = entity.Name,
            ClassId = entity.ClassId,
            ClassName = entity.Class?.Name,
            Birthday = entity.Birthday,
            Age = (DateTime.Today - entity.Birthday).Days / 365
        };
    }
    
    /// <summary>输入模型转实体</summary>
    public static Student ToEntity(this StudentInput input)
    {
        if (input == null) return null;
        
        var entity = new Student
        {
            Name = input.Name,
            ClassId = input.ClassId,
            Birthday = input.Birthday ?? DateTime.MinValue,
            Remark = input.Remark
        };
        
        return entity;
    }
    
    /// <summary>输入模型更新实体</summary>
    public static void UpdateEntity(this StudentInput input, Student entity)
    {
        if (input == null || entity == null) return;
        
        entity.Name = input.Name;
        entity.ClassId = input.ClassId;
        if (input.Birthday.HasValue)
            entity.Birthday = input.Birthday.Value;
        entity.Remark = input.Remark;
    }
}
```

### 使用 Copy 方法

XCode 实体支持 `Copy` 方法进行属性复制：

```csharp
// 从模型复制到实体
public ActionResult Add(StudentInput input)
{
    var entity = new Student();
    entity.Copy(input);
    entity.Insert();
    
    return Ok(entity.ToOutput());
}

// 从实体复制到模型
public ActionResult Detail(Int32 id)
{
    var entity = Student.FindById(id);
    
    var output = new StudentOutput();
    output.Copy(entity);
    
    return Ok(output);
}
```

### IEntity<TModel> 接口

```csharp
/// <summary>支持模型拷贝的实体接口</summary>
public interface IEntity<TModel>
{
    /// <summary>从模型复制</summary>
    void Copy(TModel model);
}

// 实体实现
public partial class Student : IEntity<StudentInput>
{
    public void Copy(StudentInput model)
    {
        Name = model.Name;
        ClassId = model.ClassId;
        Birthday = model.Birthday ?? DateTime.MinValue;
        Remark = model.Remark;
    }
}
```

---

## 34.4 自定义验证

### 数据注解验证

```csharp
public class StudentInput : IModel
{
    [Required(ErrorMessage = "姓名不能为空")]
    [StringLength(50, MinimumLength = 2, ErrorMessage = "姓名长度在2-50个字符")]
    public String Name { get; set; }
    
    [Range(1, Int32.MaxValue, ErrorMessage = "请选择班级")]
    public Int32 ClassId { get; set; }
    
    [DataType(DataType.Date)]
    [DisplayFormat(DataFormatString = "{0:yyyy-MM-dd}")]
    public DateTime? Birthday { get; set; }
    
    [EmailAddress(ErrorMessage = "邮箱格式不正确")]
    public String Email { get; set; }
    
    [Phone(ErrorMessage = "手机号格式不正确")]
    public String Phone { get; set; }
    
    [MaxLength(500, ErrorMessage = "备注最长500个字符")]
    public String Remark { get; set; }
    
    public Object this[String name]
    {
        get => this.GetValue(name);
        set => this.SetValue(name, value);
    }
}
```

### 自定义验证特性

```csharp
/// <summary>学号验证特性</summary>
public class StudentNoAttribute : ValidationAttribute
{
    protected override ValidationResult IsValid(Object value, ValidationContext validationContext)
    {
        if (value == null) return ValidationResult.Success;
        
        var studentNo = value.ToString();
        
        // 学号格式：年份4位 + 班级2位 + 序号3位
        if (!Regex.IsMatch(studentNo, @"^\d{4}\d{2}\d{3}$"))
            return new ValidationResult("学号格式不正确，应为9位数字");
        
        // 检查是否已存在
        var exists = Student.FindByStudentNo(studentNo);
        if (exists != null)
            return new ValidationResult("学号已存在");
        
        return ValidationResult.Success;
    }
}

// 使用
public class StudentInput
{
    [StudentNo]
    public String StudentNo { get; set; }
}
```

### IValidatableObject 接口

```csharp
public class StudentInput : IModel, IValidatableObject
{
    public String Name { get; set; }
    public Int32 ClassId { get; set; }
    public DateTime? Birthday { get; set; }
    public DateTime? GraduationDate { get; set; }
    
    public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
    {
        // 验证毕业日期必须大于生日
        if (Birthday.HasValue && GraduationDate.HasValue)
        {
            if (GraduationDate <= Birthday)
            {
                yield return new ValidationResult(
                    "毕业日期必须大于出生日期",
                    new[] { nameof(GraduationDate) });
            }
        }
        
        // 验证年龄（假设必须大于6岁）
        if (Birthday.HasValue)
        {
            var age = (DateTime.Today - Birthday.Value).Days / 365;
            if (age < 6)
            {
                yield return new ValidationResult(
                    "学生年龄必须大于6岁",
                    new[] { nameof(Birthday) });
            }
        }
    }
    
    public Object this[String name]
    {
        get => this.GetValue(name);
        set => this.SetValue(name, value);
    }
}
```

---

## 34.5 在控制器中使用模型

### EntityController 与模型

```csharp
/// <summary>学生管理控制器</summary>
[SchoolArea]
[DisplayName("学生管理")]
public class StudentController : EntityController<Student, StudentInput>
{
    // 使用 StudentInput 作为表单模型
    
    protected override Boolean Valid(Student entity, DataObjectMethodType type, Boolean post)
    {
        if (!post) return base.Valid(entity, type, post);
        
        // 自定义验证逻辑
        if (entity.Name.IsNullOrWhiteSpace())
            throw new ArgumentException("姓名不能为空", nameof(entity.Name));
        
        // 检查学号唯一性
        if (type == DataObjectMethodType.Insert)
        {
            var exists = Student.FindByStudentNo(entity.StudentNo);
            if (exists != null)
                throw new ArgumentException("学号已存在", nameof(entity.StudentNo));
        }
        
        return base.Valid(entity, type, post);
    }
}
```

### WebAPI 控制器与模型

```csharp
/// <summary>学生API控制器</summary>
[Route("api/[controller]")]
[ApiController]
public class StudentApiController : ControllerBase
{
    /// <summary>获取学生列表</summary>
    [HttpGet]
    public ActionResult<PagedResult<StudentListItem>> GetList([FromQuery] Pager pager)
    {
        var list = Student.Search(pager);
        
        var items = list.Select(e => new StudentListItem
        {
            Id = e.Id,
            Name = e.Name,
            ClassName = e.Class?.Name,
            Age = (DateTime.Today - e.Birthday).Days / 365
        }).ToList();
        
        return Ok(new PagedResult<StudentListItem>
        {
            Data = items,
            Total = pager.TotalCount,
            PageIndex = pager.PageIndex,
            PageSize = pager.PageSize
        });
    }
    
    /// <summary>获取学生详情</summary>
    [HttpGet("{id}")]
    public ActionResult<StudentOutput> GetDetail(Int32 id)
    {
        var entity = Student.FindById(id);
        if (entity == null) return NotFound();
        
        return Ok(entity.ToOutput());
    }
    
    /// <summary>添加学生</summary>
    [HttpPost]
    public ActionResult<StudentOutput> Create([FromBody] StudentInput input)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
        
        var entity = input.ToEntity();
        entity.Insert();
        
        return CreatedAtAction(nameof(GetDetail), new { id = entity.Id }, entity.ToOutput());
    }
    
    /// <summary>更新学生</summary>
    [HttpPut("{id}")]
    public ActionResult<StudentOutput> Update(Int32 id, [FromBody] StudentInput input)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
        
        var entity = Student.FindById(id);
        if (entity == null) return NotFound();
        
        input.UpdateEntity(entity);
        entity.Update();
        
        return Ok(entity.ToOutput());
    }
    
    /// <summary>删除学生</summary>
    [HttpDelete("{id}")]
    public ActionResult Delete(Int32 id)
    {
        var entity = Student.FindById(id);
        if (entity == null) return NotFound();
        
        entity.Delete();
        
        return NoContent();
    }
}
```

---

## 34.6 ICubeModel 接口

### 接口定义

`ICubeModel` 是魔方内部使用的模型接口，用于 JsonModelBinder 识别：

```csharp
/// <summary>魔方模型接口</summary>
public interface ICubeModel { }
```

### 使用示例

```csharp
/// <summary>登录模型</summary>
public class LoginModel : ICubeModel
{
    /// <summary>用户名</summary>
    public String Username { get; set; }
    
    /// <summary>密码</summary>
    public String Password { get; set; }
    
    /// <summary>记住我</summary>
    public Boolean Remember { get; set; }
    
    /// <summary>公钥</summary>
    public String Pkey { get; set; }
}

/// <summary>验证码模型</summary>
public class VerifyCodeModel : ICubeModel
{
    /// <summary>账号（手机号/邮箱）</summary>
    public String Username { get; set; }
    
    /// <summary>渠道（Sms/Mail）</summary>
    public String Channel { get; set; }
    
    /// <summary>场景</summary>
    public String Scene { get; set; }
}
```

---

## 34.7 最佳实践

### 1. 分离关注点

```csharp
// ? 正确：使用不同的模型处理不同场景
public class StudentCreateInput { }   // 创建输入
public class StudentUpdateInput { }   // 更新输入
public class StudentListOutput { }    // 列表输出
public class StudentDetailOutput { }  // 详情输出

// ? 避免：一个模型用于所有场景
public class StudentModel { }  // 既用于输入又用于输出
```

### 2. 保护敏感字段

```csharp
// 输入模型不包含敏感字段
public class UserInput
{
    public String Name { get; set; }
    public String Email { get; set; }
    // 不包含 Password、IsAdmin 等敏感字段
}

// 输出模型隐藏敏感信息
public class UserOutput
{
    public Int32 Id { get; set; }
    public String Name { get; set; }
    public String Email { get; set; }
    // 不输出 Password
}
```

### 3. 使用记录类型（C# 9+）

```csharp
// 使用 record 简化模型定义
public record StudentInput(String Name, Int32 ClassId, DateTime? Birthday);

public record StudentOutput(Int32 Id, String Name, String ClassName, Int32 Age);
```

### 4. 统一响应格式

```csharp
/// <summary>分页结果</summary>
public class PagedResult<T>
{
    public IList<T> Data { get; set; }
    public Int64 Total { get; set; }
    public Int32 PageIndex { get; set; }
    public Int32 PageSize { get; set; }
}

/// <summary>API响应</summary>
public class ApiResult<T>
{
    public Int32 Code { get; set; }
    public String Message { get; set; }
    public T Data { get; set; }
}
```

---

## 本章小结

本章介绍了魔方中自定义实体与模型的方法：

1. **IModel 接口**：通用数据模型接口
2. **Model 层设计**：分层架构和模型类型
3. **实体与模型映射**：手动映射和 Copy 方法
4. **自定义验证**：数据注解和自定义验证
5. **ICubeModel 接口**：魔方内部模型标识

良好的模型设计是构建可维护应用的基础。

---

**下一章**：[快速开始WebAPI版](快速开始WebAPI版.md) - 了解 WebAPI 版魔方的使用
