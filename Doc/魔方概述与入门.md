# 魔方概述与入门

> 本文档是《魔方开发手册》的第一部分，面向开发者介绍魔方的基本概念和快速入门方法。
> 
> **在线教程**：https://newlifex.com/cube  
> **演示站点**：https://cube.newlifex.com  
> **用户中心**：https://sso.newlifex.com

---

## 第1章 魔方简介

### 1.1 什么是魔方？

魔方（NewLife.Cube）是新生命团队（NewLife）打造的一套 **Web 快速开发平台**，基于 ASP.NET Core 构建。它提供了完整的后台管理系统基础设施，包括：

- **用户权限管理**：用户、角色、菜单、权限的完整体系
- **通用数据管理**：基于实体的 CRUD 操作，自动生成列表、表单、详情页
- **系统管理功能**：日志、配置、字典、定时任务等
- **多种扩展机制**：主题皮肤、OAuth 登录、数据权限等

魔方的核心理念是 **"约定优于配置"**，通过合理的默认行为和简洁的扩展接口，让开发者能够快速搭建功能完备的管理系统。

### 1.2 核心价值与特性

#### 快速搭建系统原型

- **5分钟启动**：引入 NuGet 包，配置连接字符串，即可运行
- **零代码 CRUD**：实体类自动生成完整的增删改查页面
- **自动建表**：XCode ORM 自动创建和演进数据库结构

#### 灵活的可扩展性

- **视图覆写**：在子项目中放置同名视图即可覆盖默认页面
- **控制器继承**：继承 `EntityController` 扩展业务逻辑
- **主题切换**：支持多种 UI 主题，可自定义皮肤

#### 单表100亿数据实战验证

- **大数据支持**：自动分表、读写分离、二级缓存
- **高性能设计**：对象池、数组池、Span 优化
- **生产验证**：在新生命团队的多个项目中经受百亿级数据考验

### 1.3 总体架构图解

```
┌─────────────────────────────────────────────────────────────┐
│                        前端展示层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ MVC 视图     │  │ WebAPI     │  │ 前端框架            │  │
│  │ (Razor)     │  │ (JSON)     │  │ (Vue/React/Blazor)  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                        魔方核心层                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │EntityController│ │ 权限系统   │  │ 视图引擎            │  │
│  │(实体控制器)   │  │ (RBAC)    │  │ (嵌入式资源)        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 菜单系统     │  │ OAuth/SSO  │  │ 主题皮肤            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                        数据访问层                            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              XCode ORM (NewLife.XCode)                  ││
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   ││
│  │  │ 实体模型 │ │ 自动建表 │ │ 缓存    │ │ 分表/读写分离│   ││
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────────┘   ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│                        数据库层                              │
│  ┌───────┐ ┌───────┐ ┌────────┐ ┌────────┐ ┌────────────┐  │
│  │SQLite │ │ MySQL │ │SQL Server│ │PostgreSQL│ │Oracle/达梦│  │
│  └───────┘ └───────┘ └────────┘ └────────┘ └────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 第二代魔方 vs 第三代魔方

魔方目前有两个主要版本，适用于不同的开发场景：

| 特性 | 第二代魔方（MVC版） | 第三代魔方（WebAPI版） |
|------|-------------------|---------------------|
| **项目名称** | NewLife.CubeNC | NewLife.Cube |
| **NuGet 包** | `NewLife.Cube.Core` | `NewLife.Cube` |
| **架构模式** | 服务端渲染（SSR） | 前后端分离 |
| **视图技术** | Razor 视图 | JSON API + 前端框架 |
| **适用场景** | 快速开发、内部系统 | 复杂前端、移动端对接 |
| **开箱即用** | ? 页面即用 | ?? 需配合前端项目 |
| **灵活性** | 中等 | 高 |

**选型建议**：

- **选择 MVC 版**：快速搭建管理后台、内部系统、原型验证
- **选择 WebAPI 版**：需要自定义前端、移动端对接、微服务架构

### 1.5 项目结构与子工程说明

魔方解决方案包含多个项目，各有分工：

```
NewLife.Cube/
├── NewLife.Cube/              # 第三代魔方核心（WebAPI版）
├── NewLife.CubeNC/            # 第二代魔方核心（MVC版）
├── NewLife.Cube.Core/         # MVC版 NuGet 打包项目
├── NewLife.Cube.Extensions/   # 扩展功能
│
├── 主题皮肤项目/
│   ├── NewLife.Cube.AdminLTE/    # AdminLTE 主题
│   ├── NewLife.Cube.Metronic/    # Metronic 主题
│   ├── NewLife.Cube.Metronic8/   # Metronic8 主题
│   ├── NewLife.Cube.Tabler/      # Tabler 主题
│   ├── NewLife.Cube.LayuiAdmin/  # LayuiAdmin 主题
│   └── NewLife.Cube.ElementUI/   # ElementUI 主题
│
├── 前端项目/
│   ├── NewLife.CubeVue/       # Vue 版前端
│   ├── NewLife.QuickVue/      # 快速 Vue 前端
│   ├── NewLife.CubeAntd/      # Antd 版前端
│   └── NewLife.CubeBlazor/    # Blazor 版前端
│
├── 示例项目/
│   ├── CubeSSO/               # SSO 用户中心示例（MVC版）
│   └── CubeDemo/              # WebAPI 版示例
│
└── XUnitTest/                 # 单元测试
```

### 1.6 演示站点与资源链接

| 资源 | 地址 | 说明 |
|------|------|------|
| **演示站点** | https://cube.newlifex.com | 在线体验魔方功能 |
| **用户中心** | https://sso.newlifex.com | SSO 单点登录示例 |
| **在线教程** | https://newlifex.com/cube | 详细教程文档 |
| **GitHub** | https://github.com/NewLifeX/NewLife.Cube | 源码仓库 |
| **Gitee** | https://gitee.com/NewLifeX/NewLife.Cube | 国内镜像 |
| **NuGet** | `NewLife.Cube.Core` / `NewLife.Cube` | NuGet 包 |

---

## 第2章 快速开始（MVC版）

### 2.1 环境准备

#### 开发工具

推荐使用以下任一开发工具：

- **Visual Studio 2022**（推荐）：功能最完整，调试体验最佳
- **Visual Studio Code**：轻量级，跨平台
- **JetBrains Rider**：跨平台，智能提示强大

#### .NET SDK 版本要求

魔方支持多个 .NET 版本：

| .NET 版本 | 支持状态 | 推荐程度 |
|-----------|----------|----------|
| .NET 10 | ? 支持 | ?? 最新 |
| .NET 9 | ? 支持 | ?? 推荐 |
| .NET 8 | ? 支持 | ?? 推荐（LTS） |
| .NET 7 | ? 支持 | ?? 已结束支持 |
| .NET 6 | ? 支持 | ?? LTS 即将结束 |

**检查 SDK 版本**：

```bash
dotnet --version
```

### 2.2 安装试用（VS2022 + .NET8 + MVC）

> 详细教程：https://newlifex.com/cube/install_on_net_8_with_vs2022

#### 步骤1：创建项目

1. 打开 Visual Studio 2022
2. 选择 **创建新项目**
3. 选择 **ASP.NET Core Web 应用**（注意不是 API）
4. 项目名称：`MyWebApp`（或自定义名称）
5. 框架选择 **.NET 8.0**
6. 模板选择 **空**

#### 步骤2：安装 NuGet 包

在 **NuGet 包管理器** 中搜索并安装：

```
NewLife.Cube.Core
```

或使用命令行：

```bash
dotnet add package NewLife.Cube.Core
```

#### 步骤3：配置 Program.cs

修改 `Program.cs` 文件：

```csharp
using NewLife.Cube;
using NewLife.Log;

// 日志输出到控制台
XTrace.UseConsole();

var builder = WebApplication.CreateBuilder(args);

// 添加魔方服务
builder.Services.AddCube();

var app = builder.Build();

// 使用魔方中间件
app.UseCube(builder.Environment);

app.Run();
```

#### 步骤4：配置连接字符串

在 `appsettings.json` 中添加数据库连接：

```json
{
  "ConnectionStrings": {
    "Membership": "Data Source=Data\\Membership.db"
  }
}
```

> 默认使用 SQLite 数据库，无需安装额外数据库软件。

#### 步骤5：运行项目

按 **F5** 或点击 **启动** 按钮运行项目。

首次运行时，魔方会自动：
1. 创建数据库和表结构
2. 初始化默认管理员账户
3. 生成系统菜单

#### 步骤6：登录系统

访问 `http://localhost:端口/Admin`，使用默认账户登录：

- **用户名**：admin
- **密码**：admin

> ?? **安全提醒**：首次登录后请立即修改默认密码！

### 2.3 安装试用（VS2022 + .NET7 + MVC）

> 详细教程：https://newlifex.com/cube/install_on_net_7_with_vs2022

与 .NET 8 的安装步骤基本相同，主要区别：

1. 创建项目时选择 **.NET 7.0** 框架
2. 其他步骤完全一致

### 2.4 安装试用（VS2019 + .NET Core 3.1）

> 详细教程：https://newlifex.com/cube/install

对于需要支持旧版本的项目：

1. 使用 Visual Studio 2019
2. 创建 ASP.NET Core 3.1 Web 应用
3. 安装 `NewLife.Cube.Core` 较早版本
4. 配置方式略有不同，参考在线教程

### 2.5 使用项目模板快速创建

魔方提供了 dotnet 模板，可以一键创建项目：

#### 安装模板

```bash
dotnet new install NewLife.Cube.Template
```

#### 创建魔方项目

```bash
# 创建完整的魔方项目
dotnet new cube -n MyWebApp

# 创建数据层项目（仅 XCode 实体）
dotnet new xcode -n MyData
```

#### 模板说明

| 模板 | 命令 | 说明 |
|------|------|------|
| cube | `dotnet new cube` | 完整魔方 Web 项目 |
| xcode | `dotnet new xcode` | XCode 数据层项目 |

### 2.6 示例项目说明

#### CubeSSO（MVC 版示例）

`CubeSSO` 是魔方的 SSO 单点登录示例项目，演示了：

- 完整的用户中心功能
- OAuth 第三方登录集成
- SSO 服务端配置

**运行方式**：

```bash
cd CubeSSO
dotnet run
```

#### CubeDemo（WebAPI 版示例）

`CubeDemo` 是 WebAPI 版魔方的示例项目，演示了：

- 前后端分离架构
- RESTful API 设计
- Swagger 文档集成

---

## 第3章 从零开始完整教程

### 3.1 魔方快速开发平台

> 详细教程：https://newlifex.com/cube/cube_fast

本节介绍如何从零开始，使用魔方快速搭建一个完整的管理系统。

#### 新建项目

1. 创建 ASP.NET Core Web 应用
2. 选择空模板
3. 配置项目名称和位置

#### 引入魔方

```bash
dotnet add package NewLife.Cube.Core
```

#### 魔方基本功能讲解

引入魔方后，系统自动具备以下功能：

| 功能模块 | 说明 |
|---------|------|
| 用户管理 | 用户的增删改查、启用禁用 |
| 角色管理 | 角色定义、权限分配 |
| 菜单管理 | 菜单树结构、图标配置 |
| 日志管理 | 操作日志、访问日志 |
| 系统设置 | 基础配置、登录设置 |

### 3.2 从零开始快速开发

> 详细教程：https://newlifex.com/cube/zero_fast

基于 NewLife.Zero 项目模板，演示完整的开发流程。

#### 新建模型

使用 XCode 工具设计数据模型：

```xml
<?xml version="1.0" encoding="utf-8"?>
<EntityModel>
  <Table Name="Product" Description="产品">
    <Columns>
      <Column Name="Id" DataType="Int32" Identity="True" PrimaryKey="True" Description="编号" />
      <Column Name="Name" DataType="String" Length="50" Description="名称" />
      <Column Name="Price" DataType="Decimal" Description="价格" />
      <Column Name="CreateTime" DataType="DateTime" Description="创建时间" />
    </Columns>
  </Table>
</EntityModel>
```

#### 生成实体类

使用 XCode 命令行工具生成实体：

```bash
xcodetool build Model.xml
```

生成的实体类自动包含：

- 属性定义
- 数据库映射
- CRUD 方法
- 验证逻辑

#### 新建页面

创建控制器继承 `EntityController`：

```csharp
using NewLife.Cube;
using MyApp.Data;

namespace MyApp.Web.Areas.Admin.Controllers;

[Menu("产品管理")]
[AdminArea]
public class ProductController : EntityController<Product>
{
    static ProductController()
    {
        // 配置列表显示字段
        ListFields.RemoveField("Id");
        
        // 配置搜索字段
        var df = ListFields.AddListField("Name");
        df.DataSource = entity => (entity as Product)?.Name;
    }
}
```

### 3.3 魔方从零开始 VS2022+NET8+MVC（上）

> 详细教程：https://newlifex.com/cube/cube_zero_start_vs2022_net8_mvc

#### 完整项目创建流程

1. **创建解决方案结构**

```
MySolution/
├── MySolution.Web/      # Web 项目
├── MySolution.Data/     # 数据层项目
└── MySolution.sln
```

2. **数据层项目配置**

```bash
cd MySolution.Data
dotnet add package NewLife.XCode
```

3. **Web 项目配置**

```bash
cd MySolution.Web
dotnet add package NewLife.Cube.Core
dotnet add reference ../MySolution.Data/MySolution.Data.csproj
```

#### 实体建模与生成

设计 `Model.xml` 文件，定义业务实体结构，然后使用 xcodetool 生成代码。

#### 控制器开发

为每个实体创建对应的控制器，继承 `EntityController<T>`。

### 3.4 魔方从零开始 VS2022+NET8+MVC（下）

> 详细教程：https://newlifex.com/cube/cube_zero_start_vs2022_net8_mvc_02

#### 自定义页面替换框架页面

通过视图覆写机制，可以替换魔方的默认页面：

1. 在 Web 项目中创建相同路径的视图文件
2. 魔方会优先使用子项目中的视图

例如，覆写列表页：

```
MySolution.Web/
└── Areas/
    └── Admin/
        └── Views/
            └── Product/
                └── Index.cshtml  # 自定义列表页
```

#### 自定义启动页

修改默认的启动页面，展示业务仪表盘：

```csharp
// 在 Program.cs 中配置
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");
```

#### 高级定制技巧

- 使用 `ViewBag` 传递自定义数据
- 使用 `Partial View` 复用组件
- 使用 `ViewComponent` 封装复杂逻辑

### 3.5 魔方实战：终端项目管理

> 详细教程：https://newlifex.com/cube/ee9qb1

通过一个完整的实战案例，演示魔方在实际项目中的应用：

1. **需求分析**：管理终端设备的基本信息
2. **数据建模**：设计终端实体和关联实体
3. **控制器开发**：实现业务逻辑
4. **页面定制**：自定义展示效果
5. **权限配置**：设置访问控制

---

## 本章小结

通过本部分的学习，你应该已经掌握了：

1. **魔方的定位和价值**：快速开发 Web 管理系统的利器
2. **两代魔方的区别**：MVC 版开箱即用，WebAPI 版灵活对接
3. **快速开始的方法**：5 分钟内运行起第一个魔方项目
4. **从零开始的完整流程**：建模、生成、开发、定制

**下一步**：

- 深入学习 [实体控制器](实体控制器.md) 的用法
- 了解 [权限系统](权限系统.md) 的配置
- 探索 [视图体系](视图体系.md) 的定制方法

---

## 参考资源

- [魔方功能特点与最佳实践](https://newlifex.com/cube/feature)
- [安装试用（VS2022+.NET8+MVC）](https://newlifex.com/cube/install_on_net_8_with_vs2022)
- [魔方从零开始 VS2022+NET8+MVC（上）](https://newlifex.com/cube/cube_zero_start_vs2022_net8_mvc)
- [魔方从零开始 VS2022+NET8+MVC（下）](https://newlifex.com/cube/cube_zero_start_vs2022_net8_mvc_02)
- [魔方快速开发平台](https://newlifex.com/cube/cube_fast)
- [从零开始快速开发](https://newlifex.com/cube/zero_fast)
