# 第39章 项目架构建议

> 本章介绍基于魔方开发应用系统的推荐架构和项目组织方式。

---

## 39.1 分层架构

### 推荐的分层结构

```
┌─────────────────────────────────────┐
│         表现层 (Web/API)            │
│   Controller / View / WebAPI        │
├─────────────────────────────────────┤
│         业务层 (Service)            │
│   业务逻辑 / 流程编排 / 验证        │
├─────────────────────────────────────┤
│         数据层 (Data)               │
│   实体类 / 数据访问 / 仓储          │
├─────────────────────────────────────┤
│         基础设施层                   │
│   XCode / 缓存 / 日志 / 消息        │
└─────────────────────────────────────┘
```

### 各层职责

| 层次 | 职责 | 依赖 |
|------|------|------|
| **表现层** | 接收请求、返回响应、视图渲染 | 业务层 |
| **业务层** | 业务逻辑、流程控制、事务管理 | 数据层 |
| **数据层** | 数据访问、实体定义、查询封装 | 基础设施 |
| **基础设施** | 通用工具、框架组件 | 无 |

---

## 39.2 多项目组织

### 单体应用结构

适用于中小型项目：

```
MyApp/
├── MyApp.Web/                 # Web 项目（启动项目）
│   ├── Areas/
│   │   └── School/
│   │       └── Controllers/
│   ├── Controllers/
│   ├── Views/
│   ├── Program.cs
│   └── MyApp.Web.csproj
│
├── MyApp.Data/                # 数据层
│   ├── Entity/
│   │   ├── Student.cs
│   │   └── Class.cs
│   ├── Model.xml
│   └── MyApp.Data.csproj
│
└── MyApp.sln
```

### 多层应用结构

适用于中大型项目：

```
MyApp/
├── src/
│   ├── MyApp.Web/             # Web 表现层
│   │   ├── Areas/
│   │   ├── Controllers/
│   │   └── MyApp.Web.csproj
│   │
│   ├── MyApp.Service/         # 业务服务层
│   │   ├── StudentService.cs
│   │   ├── ClassService.cs
│   │   └── MyApp.Service.csproj
│   │
│   └── MyApp.Data/            # 数据访问层
│       ├── Entity/
│       ├── Model.xml
│       └── MyApp.Data.csproj
│
├── tests/
│   ├── MyApp.UnitTests/
│   └── MyApp.IntegrationTests/
│
└── MyApp.sln
```

### 微服务结构

适用于大型分布式系统：

```
MyApp/
├── services/
│   ├── MyApp.UserService/     # 用户服务
│   ├── MyApp.OrderService/    # 订单服务
│   └── MyApp.ProductService/  # 产品服务
│
├── gateways/
│   └── MyApp.Gateway/         # API 网关
│
├── shared/
│   ├── MyApp.Shared.Data/     # 共享数据层
│   └── MyApp.Shared.Models/   # 共享模型
│
└── MyApp.sln
```

---

## 39.3 共享数据层

### 数据层项目结构

```
MyApp.Data/
├── Entity/                    # 实体类
│   ├── Student.cs
│   ├── Student.Biz.cs        # 业务逻辑扩展
│   └── Class.cs
│
├── Model.xml                  # 实体模型定义
│
├── Migrations/               # 数据迁移（可选）
│
└── MyApp.Data.csproj
```

### 实体类分离

```csharp
// Student.cs - 由代码生成器生成，不要手动修改
public partial class Student : Entity<Student>
{
    public Int32 Id { get; set; }
    public String Name { get; set; }
    public Int32 ClassId { get; set; }
}

// Student.Biz.cs - 业务逻辑扩展，手动编写
public partial class Student
{
    /// <summary>班级名称</summary>
    [Map(nameof(ClassId))]
    public String ClassName => Class?.Name;
    
    /// <summary>班级</summary>
    public Class Class => Extends.Get(nameof(Class), k => Class.FindById(ClassId));
    
    /// <summary>搜索</summary>
    public static IList<Student> Search(Int32 classId, String name, Pager p)
    {
        var exp = new WhereExpression();
        if (classId > 0) exp &= _.ClassId == classId;
        if (!name.IsNullOrEmpty()) exp &= _.Name.Contains(name);
        
        return FindAll(exp, p);
    }
}
```

### 多项目引用

```xml
<!-- MyApp.Web.csproj -->
<ItemGroup>
    <ProjectReference Include="..\MyApp.Data\MyApp.Data.csproj" />
    <ProjectReference Include="..\MyApp.Service\MyApp.Service.csproj" />
</ItemGroup>

<!-- MyApp.Service.csproj -->
<ItemGroup>
    <ProjectReference Include="..\MyApp.Data\MyApp.Data.csproj" />
</ItemGroup>
```

---

## 39.4 业务服务层设计

### 服务接口定义

```csharp
/// <summary>学生服务接口</summary>
public interface IStudentService
{
    /// <summary>获取学生列表</summary>
    PagedResult<StudentDto> GetList(StudentQuery query);
    
    /// <summary>获取学生详情</summary>
    StudentDto GetDetail(Int32 id);
    
    /// <summary>添加学生</summary>
    Int32 Add(StudentInput input);
    
    /// <summary>更新学生</summary>
    void Update(Int32 id, StudentInput input);
    
    /// <summary>删除学生</summary>
    void Delete(Int32 id);
}
```

### 服务实现

```csharp
/// <summary>学生服务</summary>
public class StudentService : IStudentService
{
    private readonly ITracer _tracer;
    
    public StudentService(ITracer tracer)
    {
        _tracer = tracer;
    }
    
    public PagedResult<StudentDto> GetList(StudentQuery query)
    {
        using var span = _tracer?.NewSpan(nameof(GetList), query);
        
        var pager = new Pager
        {
            PageIndex = query.PageIndex,
            PageSize = query.PageSize,
            Sort = query.Sort,
            Desc = query.Desc
        };
        
        var list = Student.Search(query.ClassId, query.Name, pager);
        
        return new PagedResult<StudentDto>
        {
            Data = list.Select(e => e.ToDto()).ToList(),
            Total = pager.TotalCount
        };
    }
    
    public Int32 Add(StudentInput input)
    {
        var entity = new Student();
        entity.Copy(input);
        entity.Insert();
        
        return entity.Id;
    }
}
```

### 服务注册

```csharp
// Program.cs
builder.Services.AddScoped<IStudentService, StudentService>();
builder.Services.AddScoped<IClassService, ClassService>();
```

---

## 39.5 控制器设计

### 简单控制器（直接使用实体）

```csharp
/// <summary>学生管理</summary>
[SchoolArea]
public class StudentController : EntityController<Student>
{
    // 使用 EntityController 的默认实现
}
```

### 服务控制器（使用服务层）

```csharp
/// <summary>学生API</summary>
[Route("api/[controller]")]
[ApiController]
public class StudentApiController : ControllerBase
{
    private readonly IStudentService _studentService;
    
    public StudentApiController(IStudentService studentService)
    {
        _studentService = studentService;
    }
    
    [HttpGet]
    public ActionResult<PagedResult<StudentDto>> GetList([FromQuery] StudentQuery query)
    {
        return Ok(_studentService.GetList(query));
    }
    
    [HttpPost]
    public ActionResult<Int32> Add([FromBody] StudentInput input)
    {
        var id = _studentService.Add(input);
        return CreatedAtAction(nameof(GetDetail), new { id }, id);
    }
}
```

---

## 39.6 配置管理

### 配置文件组织

```
MyApp.Web/
├── appsettings.json              # 基础配置
├── appsettings.Development.json  # 开发环境
├── appsettings.Production.json   # 生产环境
└── Config/
    ├── CubeSetting.config        # 魔方配置
    └── SysConfig.config          # 系统配置
```

### 配置类

```csharp
/// <summary>应用配置</summary>
public class AppSetting : Config<AppSetting>
{
    /// <summary>系统名称</summary>
    [Description("系统名称")]
    public String Name { get; set; } = "我的应用";
    
    /// <summary>每页显示数量</summary>
    [Description("每页显示数量")]
    public Int32 PageSize { get; set; } = 20;
    
    /// <summary>上传路径</summary>
    [Description("上传路径")]
    public String UploadPath { get; set; } = "Uploads";
}

// 使用
var name = AppSetting.Current.Name;
```

---

## 39.7 最佳实践

### 1. 实体类只做数据访问

```csharp
// ? 正确：实体类提供数据访问方法
public partial class Student
{
    public static IList<Student> Search(Int32 classId, String name, Pager p) { }
    public static Student FindById(Int32 id) => Find(_.Id == id);
}

// ? 避免：实体类包含复杂业务逻辑
public partial class Student
{
    public void EnrollCourse(Course course) { } // 复杂业务逻辑应放在服务层
}
```

### 2. 服务层处理业务逻辑

```csharp
// ? 正确：服务层处理跨实体的业务逻辑
public class EnrollmentService
{
    public void EnrollStudent(Int32 studentId, Int32 courseId)
    {
        var student = Student.FindById(studentId);
        var course = Course.FindById(courseId);
        
        // 验证
        if (student == null) throw new Exception("学生不存在");
        if (course == null) throw new Exception("课程不存在");
        if (course.IsFull) throw new Exception("课程已满");
        
        // 创建选课记录
        var enrollment = new Enrollment
        {
            StudentId = studentId,
            CourseId = courseId,
            EnrollTime = DateTime.Now
        };
        enrollment.Insert();
        
        // 更新课程人数
        course.CurrentCount++;
        course.Update();
    }
}
```

### 3. 控制器保持简洁

```csharp
// ? 正确：控制器只做请求处理和响应
[HttpPost("enroll")]
public ActionResult Enroll(Int32 studentId, Int32 courseId)
{
    _enrollmentService.EnrollStudent(studentId, courseId);
    return Ok();
}

// ? 避免：控制器包含业务逻辑
[HttpPost("enroll")]
public ActionResult Enroll(Int32 studentId, Int32 courseId)
{
    var student = Student.FindById(studentId);
    var course = Course.FindById(courseId);
    // ... 大量业务逻辑
}
```

---

## 本章小结

本章介绍了项目架构建议：

1. **分层架构**：表现层、业务层、数据层
2. **多项目组织**：单体、多层、微服务
3. **共享数据层**：实体类分离
4. **业务服务层**：服务接口和实现
5. **最佳实践**：各层职责分离

良好的架构设计是构建可维护系统的基础。

---

**下一章**：[性能优化](性能优化.md) - 了解性能优化技巧
