# 第9章 数据权限

> 本章介绍魔方的数据权限系统，实现数据级别的访问控制。
> 
> 数据权限在菜单权限基础上，进一步限制用户能够操作的数据范围。

---

## 9.1 数据权限概述

### 什么是数据权限

数据权限是在功能权限（菜单/操作权限）基础上的进一步细化：

| 权限类型 | 控制对象 | 示例 |
|---------|---------|------|
| 功能权限 | 能做什么操作 | 能否访问用户管理、能否删除数据 |
| 数据权限 | 能操作哪些数据 | 只能看到本部门数据、只能编辑自己创建的数据 |

### 应用场景

- **多部门系统**：各部门只能看到本部门数据
- **多租户系统**：租户之间数据完全隔离
- **分级管理**：上级可以看到下级数据
- **创建者限制**：只能操作自己创建的数据

---

## 9.2 DataPermissionAttribute 特性

### 基本用法

```csharp
[DataPermission("TenantId", "DepartmentId", "CreateUserId")]
public class ProductController : EntityController<Product>
{
    // 自动根据数据权限过滤查询结果
}
```

### 特性参数说明

```csharp
[AttributeUsage(AttributeTargets.Class)]
public class DataPermissionAttribute : Attribute
{
    /// <summary>租户字段</summary>
    public String TenantField { get; set; }
    
    /// <summary>部门字段</summary>
    public String DepartmentField { get; set; }
    
    /// <summary>创建者字段</summary>
    public String CreatorField { get; set; }
    
    /// <summary>是否启用</summary>
    public Boolean Enable { get; set; } = true;
}
```

### 完整示例

```csharp
// 产品实体
public partial class Product : Entity<Product>
{
    public Int32 TenantId { get; set; }
    public Int32 DepartmentId { get; set; }
    public Int32 CreateUserId { get; set; }
    // ... 其他字段
}

// 产品控制器
[DataPermission(TenantField = "TenantId", 
                DepartmentField = "DepartmentId", 
                CreatorField = "CreateUserId")]
public class ProductController : EntityController<Product>
{
    protected override IEnumerable<Product> Search(Pager p)
    {
        // 基类会自动添加数据权限过滤条件
        return base.Search(p);
    }
}
```

---

## 9.3 DataScopeMiddleware 中间件

### 中间件配置

```csharp
public void Configure(IApplicationBuilder app)
{
    // 启用数据权限中间件
    app.UseDataScope();
    
    // 必须在认证中间件之后
    app.UseAuthentication();
    app.UseAuthorization();
    app.UseDataScope();  // 放在这里
    
    app.UseCube(env);
}
```

### 中间件工作原理

```
请求 -> 认证 -> 授权 -> DataScopeMiddleware -> 控制器
                              |
                              v
                    读取用户数据权限配置
                              |
                              v
                    设置 DataScope 上下文
                              |
                              v
                    EntityController 自动应用
```

### 手动获取数据范围

```csharp
// 在控制器中获取当前数据范围
var scope = DataScope.Current;

// 检查数据范围类型
if (scope.Type == DataScopeType.All)
{
    // 可以看到所有数据
}
else if (scope.Type == DataScopeType.Department)
{
    // 只能看到本部门数据
    var departmentId = scope.DepartmentId;
}
else if (scope.Type == DataScopeType.Self)
{
    // 只能看到自己的数据
    var userId = scope.UserId;
}
```

---

## 9.4 数据范围控制

### 全部数据

```csharp
// 管理员角色：可以看到所有数据
var role = Role.FindByName("管理员");
role.DataScope = DataScopeType.All;
role.Update();
```

用户拥有此数据范围时，查询不添加任何过滤条件。

### 本部门数据

```csharp
// 部门经理：可以看到本部门数据
var role = Role.FindByName("部门经理");
role.DataScope = DataScopeType.Department;
role.Update();

// 自动添加的过滤条件：WHERE DepartmentId = @CurrentDepartmentId
```

### 本人数据

```csharp
// 普通员工：只能看到自己的数据
var role = Role.FindByName("普通员工");
role.DataScope = DataScopeType.Self;
role.Update();

// 自动添加的过滤条件：WHERE CreateUserId = @CurrentUserId
```

### 自定义数据范围

```csharp
// 区域经理：可以看到多个部门的数据
var role = Role.FindByName("区域经理");
role.DataScope = DataScopeType.Custom;
role.DataScopeIds = "1,2,3,4,5";  // 可访问的部门ID列表
role.Update();

// 自动添加的过滤条件：WHERE DepartmentId IN (1,2,3,4,5)
```

### DataScopeType 枚举

```csharp
public enum DataScopeType
{
    /// <summary>全部数据</summary>
    All = 0,
    
    /// <summary>本部门数据</summary>
    Department = 1,
    
    /// <summary>本部门及下级部门数据</summary>
    DepartmentAndChild = 2,
    
    /// <summary>本人数据</summary>
    Self = 3,
    
    /// <summary>自定义数据范围</summary>
    Custom = 4
}
```

---

## 9.5 数据权限配置与使用

### 角色数据权限配置

在角色管理界面配置数据权限：

```csharp
// 获取角色
var role = Role.FindById(roleId);

// 配置数据范围
role.DataScope = DataScopeType.Department;
role.Update();
```

### 用户数据权限配置

用户可以覆盖角色的数据权限：

```csharp
// 获取用户
var user = User.FindById(userId);

// 设置用户特定的数据权限（优先级高于角色）
user.DataScope = DataScopeType.Custom;
user.DataScopeIds = "1,2,3";
user.Update();
```

### 控制器中应用数据权限

```csharp
[DataPermission("TenantId", "DepartmentId", "CreateUserId")]
public class OrderController : EntityController<Order>
{
    protected override IEnumerable<Order> Search(Pager p)
    {
        var exp = new WhereExpression();
        
        // 业务查询条件
        var status = p["status"].ToInt();
        if (status > 0)
            exp &= Order._.Status == status;
        
        // 数据权限会自动添加（由基类处理）
        return Order.FindAll(exp, p);
    }
    
    // 编辑时也需要检查数据权限
    protected override Order Find(Object key)
    {
        var entity = base.Find(key);
        
        // 检查数据权限
        if (!HasDataPermission(entity))
            throw new UnauthorizedAccessException("无权操作此数据");
        
        return entity;
    }
    
    private Boolean HasDataPermission(Order entity)
    {
        var scope = DataScope.Current;
        
        return scope.Type switch
        {
            DataScopeType.All => true,
            DataScopeType.Department => entity.DepartmentId == scope.DepartmentId,
            DataScopeType.Self => entity.CreateUserId == scope.UserId,
            DataScopeType.Custom => scope.DataScopeIds.Contains(entity.DepartmentId.ToString()),
            _ => false
        };
    }
}
```

### 手动构建数据权限条件

```csharp
protected WhereExpression BuildDataPermissionCondition()
{
    var exp = new WhereExpression();
    var scope = DataScope.Current;
    
    switch (scope.Type)
    {
        case DataScopeType.All:
            // 不添加条件
            break;
            
        case DataScopeType.Department:
            exp &= Order._.DepartmentId == scope.DepartmentId;
            break;
            
        case DataScopeType.DepartmentAndChild:
            var deptIds = GetDepartmentAndChildIds(scope.DepartmentId);
            exp &= Order._.DepartmentId.In(deptIds);
            break;
            
        case DataScopeType.Self:
            exp &= Order._.CreateUserId == scope.UserId;
            break;
            
        case DataScopeType.Custom:
            var ids = scope.DataScopeIds.Split(',').Select(Int32.Parse);
            exp &= Order._.DepartmentId.In(ids);
            break;
    }
    
    return exp;
}
```

---

## 数据权限最佳实践

### 1. 实体设计

确保实体包含数据权限所需字段：

```csharp
public partial class Order : Entity<Order>
{
    /// <summary>租户ID</summary>
    public Int32 TenantId { get; set; }
    
    /// <summary>部门ID</summary>
    public Int32 DepartmentId { get; set; }
    
    /// <summary>创建人ID</summary>
    public Int32 CreateUserId { get; set; }
    
    /// <summary>创建人</summary>
    public String CreateUser { get; set; }
    
    /// <summary>创建时间</summary>
    public DateTime CreateTime { get; set; }
}
```

### 2. 自动填充字段

在保存数据时自动填充权限字段：

```csharp
protected override Int32 OnInsert(Order entity)
{
    var user = ManageProvider.User as User;
    
    // 自动填充权限字段
    entity.TenantId = user?.TenantId ?? 0;
    entity.DepartmentId = user?.DepartmentId ?? 0;
    entity.CreateUserId = user?.Id ?? 0;
    entity.CreateUser = user?.Name;
    entity.CreateTime = DateTime.Now;
    
    return base.OnInsert(entity);
}
```

### 3. 性能优化

数据权限条件会影响查询性能，建议：

```csharp
// 为数据权限字段添加索引
public class Order : Entity<Order>
{
    // 在 Model.xml 中定义索引
    // <Index Columns="TenantId" />
    // <Index Columns="DepartmentId" />
    // <Index Columns="CreateUserId" />
}
```

### 4. 联合查询的数据权限

```csharp
// 主从表联合查询时，需要对主表应用数据权限
var orders = Order.FindAll(
    Order._.Status == 1 & 
    Order._.DepartmentId == currentDeptId,  // 数据权限
    null, null, 0, 100);

// 从表通过主表关联，不需要单独的数据权限
foreach (var order in orders)
{
    var items = OrderItem.FindAllByOrderId(order.Id);
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **数据权限概念**：区分功能权限和数据权限
2. **DataPermissionAttribute**：标记控制器的数据权限字段
3. **DataScopeMiddleware**：数据权限中间件的配置和原理
4. **数据范围类型**：全部、本部门、本人、自定义
5. **数据权限应用**：在查询和操作中应用数据权限

**下一步**：

- 学习 [多租户架构](多租户架构.md) 了解租户级数据隔离
- 了解 [安全与审计](安全与审计.md) 的安全增强措施

---

## 参考资源

- [角色菜单与权限控制](https://newlifex.com/cube/permission)
