# 第16章 自定义查询

> 本章介绍如何自定义魔方的查询功能，包括搜索字段配置、高级查询和查询优化。

---

## 16.1 搜索区域分析

### 搜索区域结构

```
┌─────────────────────────────────────────────────────────┐
│ 搜索区域（_List_Search）                                 │
├─────────────────────────────────────────────────────────┤
│ 名称: [__________]  分类: [全部]  状态: [全部]     │
│                                                         │
│ 创建时间: [________] 至 [________]                      │
│                                                         │
│                         [?? 搜索] [? 重置]              │
└─────────────────────────────────────────────────────────┘
```

---

## 16.2 搜索字段配置

### 在控制器中配置搜索字段

```csharp
static ProductController()
{
    // 文本搜索
    ListFields.AddSearchField("Name", "产品名称");
    ListFields.AddSearchField("Code", "产品编码");
    
    // 下拉选择
    ListFields.AddSearchField("CategoryId", "分类", SearchFieldType.Select)
        .DataSource = e => Category.FindAllWithCache()
            .ToDictionary(c => c.Id.ToString(), c => c.Name);
    
    // 状态选择
    ListFields.AddSearchField("Enable", "状态", SearchFieldType.Select)
        .DataSource = e => new Dictionary<String, String>
        {
            [""] = "全部",
            ["true"] = "启用",
            ["false"] = "禁用"
        };
    
    // 日期范围
    ListFields.AddSearchField("CreateTime", "创建时间", SearchFieldType.DateRange);
}
```

### SearchField 属性

| 属性 | 类型 | 说明 |
|------|------|------|
| Name | String | 字段名称（对应查询参数名） |
| DisplayName | String | 显示名称 |
| Type | SearchFieldType | 控件类型 |
| DataSource | Func | 数据源（用于下拉选择） |
| DefaultValue | String | 默认值 |
| Placeholder | String | 占位提示 |

---

## 16.3 重写 Search 方法

### 基本查询重写

```csharp
protected override IEnumerable<Product> Search(Pager p)
{
    // 获取查询参数
    var name = p["name"]?.Trim();
    var code = p["code"]?.Trim();
    var categoryId = p["categoryId"].ToInt();
    var enable = p["enable"];
    var dtStart = p["dtStart"].ToDateTime();
    var dtEnd = p["dtEnd"].ToDateTime();
    
    // 构建查询
    var exp = new WhereExpression();
    
    if (!name.IsNullOrEmpty())
        exp &= Product._.Name.Contains(name);
    
    if (!code.IsNullOrEmpty())
        exp &= Product._.Code.StartsWith(code);
    
    if (categoryId > 0)
        exp &= Product._.CategoryId == categoryId;
    
    if (!enable.IsNullOrEmpty())
        exp &= Product._.Enable == enable.ToBoolean();
    
    if (dtStart > DateTime.MinValue)
        exp &= Product._.CreateTime >= dtStart;
    
    if (dtEnd > DateTime.MinValue)
        exp &= Product._.CreateTime < dtEnd.Date.AddDays(1);
    
    return Product.FindAll(exp, p);
}
```

### 模糊查询 / 精确查询 / 范围查询

```csharp
protected override IEnumerable<Product> Search(Pager p)
{
    var exp = new WhereExpression();
    
    // 模糊查询（包含）
    var keyword = p["q"];
    if (!keyword.IsNullOrEmpty())
        exp &= Product._.Name.Contains(keyword) | 
               Product._.Code.Contains(keyword) |
               Product._.Description.Contains(keyword);
    
    // 精确查询（等于）
    var status = p["status"].ToInt(-1);
    if (status >= 0)
        exp &= Product._.Status == status;
    
    // 范围查询（大于/小于）
    var priceMin = p["priceMin"].ToDecimal();
    var priceMax = p["priceMax"].ToDecimal();
    if (priceMin > 0)
        exp &= Product._.Price >= priceMin;
    if (priceMax > 0)
        exp &= Product._.Price <= priceMax;
    
    // IN 查询
    var tags = p["tags"]?.Split(',');
    if (tags != null && tags.Length > 0)
        exp &= Product._.TagId.In(tags.Select(Int32.Parse));
    
    return Product.FindAll(exp, p);
}
```

---

## 16.4 自定义搜索视图

### 覆写 _List_Search

创建 `Areas/Admin/Views/Product/_List_Search.cshtml`：

```html
@{
    var categories = ViewBag.Categories as IList<Category>;
}

<div class="box-body">
    <form class="form-inline" method="get">
        <div class="form-group">
            <label>名称</label>
            <input type="text" name="name" value="@Request.Query["name"]" 
                   class="form-control" placeholder="产品名称" />
        </div>
        
        <div class="form-group">
            <label>分类</label>
            <select name="categoryId" class="form-control">
                <option value="">全部分类</option>
                @foreach (var cat in categories)
                {
                    var selected = Request.Query["categoryId"] == cat.Id.ToString() ? "selected" : "";
                    <option value="@cat.Id" @selected>@cat.Name</option>
                }
            </select>
        </div>
        
        <div class="form-group">
            <label>价格范围</label>
            <input type="number" name="priceMin" value="@Request.Query["priceMin"]" 
                   class="form-control" style="width:100px" placeholder="最低" />
            <span>-</span>
            <input type="number" name="priceMax" value="@Request.Query["priceMax"]" 
                   class="form-control" style="width:100px" placeholder="最高" />
        </div>
        
        <div class="form-group">
            <label>创建时间</label>
            <input type="date" name="dtStart" value="@Request.Query["dtStart"]" 
                   class="form-control" />
            <span>至</span>
            <input type="date" name="dtEnd" value="@Request.Query["dtEnd"]" 
                   class="form-control" />
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fa fa-search"></i> 搜索
        </button>
        <a href="Index" class="btn btn-default">
            <i class="fa fa-refresh"></i> 重置
        </a>
    </form>
</div>
```

---

## 16.5 高级查询功能

### 多条件组合查询

```csharp
// 支持 AND 和 OR 组合
protected override IEnumerable<Product> Search(Pager p)
{
    var exp = new WhereExpression();
    
    // 基础条件（AND）
    var categoryId = p["categoryId"].ToInt();
    if (categoryId > 0)
        exp &= Product._.CategoryId == categoryId;
    
    // 关键词搜索（OR 组合）
    var keyword = p["q"];
    if (!keyword.IsNullOrEmpty())
    {
        var keywordExp = Product._.Name.Contains(keyword) | 
                        Product._.Code.Contains(keyword);
        exp &= keywordExp;
    }
    
    // 多状态筛选（IN）
    var statuses = p["statuses"]?.Split(',').Select(Int32.Parse).ToArray();
    if (statuses != null && statuses.Length > 0)
        exp &= Product._.Status.In(statuses);
    
    return Product.FindAll(exp, p);
}
```

### 关联表查询

```csharp
protected override IEnumerable<Order> Search(Pager p)
{
    var exp = new WhereExpression();
    
    // 通过产品名称搜索订单
    var productName = p["productName"];
    if (!productName.IsNullOrEmpty())
    {
        // 先查找符合条件的产品ID
        var productIds = Product.FindAll(Product._.Name.Contains(productName))
            .Select(e => e.Id).ToList();
        
        if (productIds.Count > 0)
            exp &= Order._.ProductId.In(productIds);
        else
            return new List<Order>();  // 没有匹配的产品，返回空
    }
    
    return Order.FindAll(exp, p);
}
```

### 全文搜索

```csharp
protected override IEnumerable<Article> Search(Pager p)
{
    var keyword = p["q"];
    
    if (!keyword.IsNullOrEmpty())
    {
        // 多字段全文搜索
        var exp = Article._.Title.Contains(keyword) |
                  Article._.Summary.Contains(keyword) |
                  Article._.Content.Contains(keyword) |
                  Article._.Tags.Contains(keyword);
        
        return Article.FindAll(exp, p);
    }
    
    return Article.FindAll(null, p);
}
```

---

## 16.6 查询优化

### 索引优化

```csharp
// 为常用查询字段添加索引
// 在 Model.xml 中定义
// <Index Columns="Name" />
// <Index Columns="CategoryId" />
// <Index Columns="CreateTime" />
// <Index Columns="CategoryId,Status" />  // 组合索引
```

### 查询缓存

```csharp
protected override IEnumerable<Product> Search(Pager p)
{
    // 对于不常变化的查询，可以使用缓存
    var cacheKey = $"Product:Search:{p["categoryId"]}:{p["status"]}:{p.PageIndex}";
    
    return Cache.GetOrAdd(cacheKey, k =>
    {
        var exp = BuildSearchExpression(p);
        return Product.FindAll(exp, p).ToList();
    }, 60);  // 缓存60秒
}
```

### 延迟加载优化

```csharp
// 避免 N+1 查询问题
protected override IEnumerable<Order> Search(Pager p)
{
    var orders = Order.FindAll(null, p).ToList();
    
    // 批量加载关联数据
    var productIds = orders.Select(o => o.ProductId).Distinct().ToList();
    var products = Product.FindByIds(productIds).ToDictionary(e => e.Id);
    
    // 设置关联数据
    foreach (var order in orders)
    {
        order.SetItem("Product", products.GetValueOrDefault(order.ProductId));
    }
    
    return orders;
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **搜索字段配置**：文本、下拉、日期范围
2. **Search 方法重写**：构建查询条件
3. **搜索视图自定义**：覆写 _List_Search
4. **高级查询**：组合条件、关联查询、全文搜索
5. **查询优化**：索引、缓存、延迟加载

**下一步**：

- 学习 [自定义表单页](自定义表单页.md) 了解表单定制

---
