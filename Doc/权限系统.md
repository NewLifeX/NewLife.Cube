# 第8章 权限系统

> 本章介绍魔方的权限系统，基于 RBAC（基于角色的访问控制）模型实现。
> 
> 详细教程：https://newlifex.com/cube/permission

---

## 8.1 权限模型概述

### 用户 -> 角色 -> 菜单 -> Action

魔方采用经典的 RBAC 权限模型：

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   用户   │────>│   角色   │────>│   菜单   │────>│  Action  │
│  (User)  │ N:N │  (Role)  │ N:N │  (Menu)  │ 1:N │(操作权限) │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
```

**权限流转**：

1. **用户** 属于一个或多个 **角色**
2. **角色** 拥有多个 **菜单** 的访问权限
3. 每个 **菜单** 对应一组 **Action**（操作权限）
4. 系统根据用户角色判断是否有权执行特定 Action

### 权限粒度

| 层级 | 说明 | 示例 |
|------|------|------|
| 菜单级 | 是否能看到菜单 | 用户管理菜单 |
| 页面级 | 是否能访问页面 | 用户列表页 |
| 操作级 | 是否能执行操作 | 添加用户、删除用户 |
| 数据级 | 能操作哪些数据 | 本部门数据、本人数据 |

---

## 8.2 角色菜单与权限控制

> 详细教程：https://newlifex.com/cube/permission

### 权限原理（角色与控制器方法的关系）

每个控制器的 Action 方法对应一个权限项：

```csharp
public class ProductController : EntityController<Product>
{
    // 对应权限：ProductController.Index（查看）
    public ActionResult Index() { }
    
    // 对应权限：ProductController.Add（添加）
    public ActionResult Add() { }
    
    // 对应权限：ProductController.Edit（编辑）
    public ActionResult Edit() { }
    
    // 对应权限：ProductController.Delete（删除）
    public ActionResult Delete() { }
}
```

### 权限位运算

魔方使用位运算存储权限，提高查询效率：

```csharp
[Flags]
public enum PermissionFlags
{
    /// <summary>无权限</summary>
    None = 0,
    
    /// <summary>查看（列表、详情）</summary>
    Detail = 1,
    
    /// <summary>添加</summary>
    Insert = 2,
    
    /// <summary>修改</summary>
    Update = 4,
    
    /// <summary>删除</summary>
    Delete = 8,
    
    /// <summary>所有权限</summary>
    All = 0xFF
}
```

**位运算示例**：

```csharp
// 赋予查看和添加权限
var permission = PermissionFlags.Detail | PermissionFlags.Insert;  // = 3

// 检查是否有删除权限
var hasDelete = (permission & PermissionFlags.Delete) != 0;  // = false

// 添加修改权限
permission |= PermissionFlags.Update;  // = 7
```

### 权限分配

```csharp
// 获取角色
var role = Role.FindByName("编辑员");

// 获取菜单
var menu = Menu.FindByName("产品管理");

// 分配权限（查看 + 添加 + 修改）
role.Set(menu.Id, PermissionFlags.Detail | PermissionFlags.Insert | PermissionFlags.Update);
role.Update();
```

---

## 8.3 自定义功能按钮的权限控制

> 详细教程：https://newlifex.com/cube/permission_custom

### 精细控制权限

为自定义按钮添加权限控制：

```csharp
public class ProductController : EntityController<Product>
{
    // 自定义导出功能，使用 Detail 权限
    [EntityAuthorize(PermissionFlags.Detail)]
    [DisplayName("导出报表")]
    public ActionResult ExportReport()
    {
        // 导出逻辑
        return File(bytes, "application/octet-stream", "report.xlsx");
    }
    
    // 自定义审核功能，使用 Update 权限
    [EntityAuthorize(PermissionFlags.Update)]
    [DisplayName("审核通过")]
    public ActionResult Approve(Int32 id)
    {
        var entity = Product.FindById(id);
        entity.Status = ProductStatus.Approved;
        entity.Update();
        
        return JsonRefresh("审核成功");
    }
}
```

### 自定义权限子项

当内置权限不满足需求时，可以自定义权限项：

```csharp
public class ProductController : EntityController<Product>
{
    // 定义自定义权限常量（使用高位避免与内置权限冲突）
    private const PermissionFlags Export = (PermissionFlags)16;
    private const PermissionFlags Approve = (PermissionFlags)32;
    private const PermissionFlags Publish = (PermissionFlags)64;
    
    // 注册自定义权限到菜单
    static ProductController()
    {
        // 在静态构造函数中注册权限
        var menu = Menu.FindByName("产品管理");
        if (menu != null)
        {
            menu.Permissions = new Dictionary<PermissionFlags, String>
            {
                [PermissionFlags.Detail] = "查看",
                [PermissionFlags.Insert] = "添加",
                [PermissionFlags.Update] = "编辑",
                [PermissionFlags.Delete] = "删除",
                [Export] = "导出",
                [Approve] = "审核",
                [Publish] = "发布"
            };
        }
    }
    
    [EntityAuthorize(Export)]
    [DisplayName("导出")]
    public ActionResult Export() { }
    
    [EntityAuthorize(Approve)]
    [DisplayName("审核")]
    public ActionResult Approve() { }
    
    [EntityAuthorize(Publish)]
    [DisplayName("发布")]
    public ActionResult Publish() { }
}
```

### 按钮显示与功能控制

在视图中根据权限显示按钮：

```html
@{
    var user = ManageProvider.User as IUser;
    var menu = ViewBag.Menu as Menu;
}

@if (user.Has(menu, PermissionFlags.Insert))
{
    <a href="@Url.Action("Add")" class="btn btn-primary">
        <i class="fa fa-plus"></i> 添加
    </a>
}

@if (user.Has(menu, (PermissionFlags)16))  // 自定义导出权限
{
    <a href="@Url.Action("Export")" class="btn btn-info">
        <i class="fa fa-download"></i> 导出
    </a>
}
```

---

## 8.4 用户管理

### 用户实体（User）

魔方内置用户实体，包含以下核心字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | Int32 | 用户ID |
| Name | String | 登录名 |
| DisplayName | String | 显示名称 |
| Password | String | 密码（加密存储） |
| RoleIds | String | 角色ID列表（逗号分隔） |
| Enable | Boolean | 是否启用 |
| RegisterTime | DateTime | 注册时间 |
| LastLogin | DateTime | 最后登录时间 |

### 首个用户自动管理员机制

系统首次运行时，第一个注册的用户自动成为管理员：

```csharp
// 内置逻辑
if (User.Meta.Count == 0)
{
    // 首个用户自动分配管理员角色
    user.RoleId = Role.GetOrAdd("管理员").Id;
}
```

### 用户信息与个人设置

```csharp
// 获取当前登录用户
var user = ManageProvider.User as User;

// 修改用户信息
user.DisplayName = "新名称";
user.Email = "new@example.com";
user.Update();

// 修改密码
user.Password = user.Password.MD5();  // 加密存储
user.Update();
```

---

## 8.5 角色管理

### 角色实体（Role）

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | Int32 | 角色ID |
| Name | String | 角色名称 |
| Enable | Boolean | 是否启用 |
| IsSystem | Boolean | 是否系统角色 |
| Permission | String | 权限配置（JSON） |

### 角色权限分配

```csharp
// 获取或创建角色
var role = Role.GetOrAdd("编辑员");

// 批量设置菜单权限
var menus = new[] { "产品管理", "订单管理", "客户管理" };
foreach (var menuName in menus)
{
    var menu = Menu.FindByName(menuName);
    if (menu != null)
    {
        // 查看 + 添加 + 修改
        role.Set(menu.Id, PermissionFlags.Detail | PermissionFlags.Insert | PermissionFlags.Update);
    }
}

role.Update();
```

### 内置系统角色

| 角色 | 说明 | 默认权限 |
|------|------|----------|
| 管理员 | 系统管理员 | 所有权限 |
| 普通用户 | 默认角色 | 基础查看权限 |

---

## 8.6 菜单管理

### 菜单树结构

```csharp
// 获取完整菜单树
var rootMenus = Menu.FindAllByParentId(0);

void PrintMenuTree(Menu menu, int level = 0)
{
    Console.WriteLine(new String(' ', level * 2) + menu.Name);
    
    foreach (var child in menu.Childs)
    {
        PrintMenuTree(child, level + 1);
    }
}

foreach (var menu in rootMenus)
{
    PrintMenuTree(menu);
}
```

### 菜单自动扫描与注册

魔方启动时自动扫描控制器并注册菜单：

```csharp
// 扫描所有带 Menu 特性的控制器
var types = AssemblyX.FindAllPlugins(typeof(Controller));
foreach (var type in types)
{
    var attr = type.GetCustomAttribute<MenuAttribute>();
    if (attr != null)
    {
        // 注册菜单
        Menu.GetOrAdd(attr.Name, type.Name, attr.Parent);
    }
}
```

### MenuAttribute 特性

```csharp
[Menu("产品管理", 
    Icon = "fa-box",           // 图标
    Order = 10,                // 排序
    Parent = "业务管理",        // 父菜单
    Visible = true)]           // 是否可见
public class ProductController : EntityController<Product>
{
}
```

---

## 8.7 权限控制

### EntityAuthorize 特性

用于控制器或 Action 方法的权限控制：

```csharp
// 控制器级别权限
[EntityAuthorize]
public class ProductController : EntityController<Product>
{
    // Action 级别权限
    [EntityAuthorize(PermissionFlags.Delete)]
    public ActionResult Delete(Int32 id)
    {
        // 只有拥有删除权限的用户才能访问
    }
    
    // 允许匿名访问
    [AllowAnonymous]
    public ActionResult PublicView()
    {
        // 任何人都可以访问
    }
}
```

### PermissionFlags 枚举

```csharp
[Flags]
public enum PermissionFlags
{
    /// <summary>无权限</summary>
    None = 0,
    
    /// <summary>查看权限（包括列表和详情）</summary>
    Detail = 1,
    
    /// <summary>添加权限</summary>
    Insert = 2,
    
    /// <summary>修改权限</summary>
    Update = 4,
    
    /// <summary>删除权限</summary>
    Delete = 8,
    
    /// <summary>所有基础权限</summary>
    All = Detail | Insert | Update | Delete
}
```

### 权限检查方法

```csharp
// 在控制器中检查权限
protected Boolean HasPermission(PermissionFlags flag)
{
    var user = ManageProvider.User as IUser;
    var menu = ViewBag.Menu as Menu;
    
    return user?.Has(menu, flag) ?? false;
}

// 使用示例
public ActionResult CustomAction()
{
    if (!HasPermission(PermissionFlags.Update))
        return Content("无权限");
    
    // 执行操作
}
```

---

## 权限配置示例

### 场景1：只读用户

```csharp
var role = Role.GetOrAdd("只读用户");

// 所有菜单只给查看权限
foreach (var menu in Menu.FindAllWithCache())
{
    role.Set(menu.Id, PermissionFlags.Detail);
}

role.Update();
```

### 场景2：数据录入员

```csharp
var role = Role.GetOrAdd("数据录入员");

// 业务菜单：查看 + 添加
var businessMenus = new[] { "产品管理", "订单管理" };
foreach (var name in businessMenus)
{
    var menu = Menu.FindByName(name);
    if (menu != null)
        role.Set(menu.Id, PermissionFlags.Detail | PermissionFlags.Insert);
}

role.Update();
```

### 场景3：部门管理员

```csharp
var role = Role.GetOrAdd("部门管理员");

// 完全权限的菜单
var fullMenus = new[] { "用户管理", "日志管理" };
foreach (var name in fullMenus)
{
    var menu = Menu.FindByName(name);
    if (menu != null)
        role.Set(menu.Id, PermissionFlags.All);
}

// 只读菜单
var readOnlyMenus = new[] { "系统设置" };
foreach (var name in readOnlyMenus)
{
    var menu = Menu.FindByName(name);
    if (menu != null)
        role.Set(menu.Id, PermissionFlags.Detail);
}

role.Update();
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **RBAC 权限模型**：用户 -> 角色 -> 菜单 -> Action
2. **权限位运算**：使用 PermissionFlags 高效存储权限
3. **自定义权限**：扩展内置权限项
4. **用户/角色/菜单管理**：核心实体的使用
5. **权限检查**：EntityAuthorize 特性和代码检查

**下一步**：

- 学习 [数据权限](数据权限.md) 了解数据级访问控制
- 了解 [多租户架构](多租户架构.md) 的权限隔离

---

## 参考资源

- [角色菜单与权限控制](https://newlifex.com/cube/permission)
- [自定义功能按钮的权限控制](https://newlifex.com/cube/permission_custom)
