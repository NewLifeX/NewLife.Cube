# 第4章 实体控制器（EntityController）

> 本章介绍魔方的核心组件――实体控制器，它是构建 CRUD 页面的基础。
> 
> 实体控制器通过继承和配置，可以快速生成功能完备的管理页面。

---

## 4.1 实体控制器概述

### EntityController 与 ReadOnlyEntityController

魔方提供两种基础控制器：

| 控制器 | 功能 | 适用场景 |
|--------|------|----------|
| `EntityController<TEntity>` | 完整 CRUD | 需要增删改查的数据管理 |
| `ReadOnlyEntityController<TEntity>` | 只读查询 | 日志查看、统计报表等只读场景 |

### TEntity 与 TModel 泛型参数

```csharp
// 基础用法：实体类型
public class ProductController : EntityController<Product>
{
}

// 高级用法：实体 + 视图模型
public class ProductController : EntityController<Product, ProductModel>
{
}
```

- **TEntity**：XCode 实体类型，对应数据库表
- **TModel**：视图模型类型，用于表单绑定和展示

当只指定 `TEntity` 时，实体类同时作为视图模型使用。

---

## 4.2 静态构造器配置

实体控制器的核心配置在 **静态构造函数** 中完成：

```csharp
public class ProductController : EntityController<Product>
{
    static ProductController()
    {
        // 列表字段配置
        ListFields.RemoveField("Remark");
        ListFields.AddListField("Name", "Code");
        
        // 添加表单字段配置
        AddFormFields.RemoveField("CreateTime", "UpdateTime");
        
        // 编辑表单字段配置
        EditFormFields.AddFormField("Status");
        
        // 详情字段配置
        DetailFields.AddField("CreateUser", "CreateTime");
    }
}
```

### ListFields（列表字段）

控制列表页显示哪些字段：

```csharp
static ProductController()
{
    // 移除字段
    ListFields.RemoveField("Id", "Remark");
    
    // 添加字段
    ListFields.AddListField("Name");
    
    // 设置字段顺序
    var name = ListFields.GetField("Name");
    name.DisplayOrder = 1;
    
    // 设置字段宽度
    name.Width = "200px";
    
    // 设置字段对齐
    name.Align = "center";
}
```

### AddFormFields / EditFormFields（表单字段）

控制添加/编辑表单显示哪些字段：

```csharp
static ProductController()
{
    // 添加表单：隐藏自动字段
    AddFormFields.RemoveField("Id", "CreateTime", "UpdateTime");
    
    // 编辑表单：显示状态字段
    EditFormFields.AddFormField("Status");
    
    // 设置字段为只读
    var code = EditFormFields.GetField("Code");
    code.ReadOnly = true;
}
```

### DetailFields（详情字段）

控制详情页显示哪些字段：

```csharp
static ProductController()
{
    // 详情页显示所有字段
    DetailFields.AddField("*");
    
    // 或指定特定字段
    DetailFields.AddField("Name", "Code", "Price", "CreateTime");
}
```

### 字段显示/隐藏与排序

```csharp
static ProductController()
{
    // 隐藏字段
    ListFields.RemoveField("InternalCode");
    
    // 调整字段顺序
    var fields = ListFields;
    fields.MoveField("Name", 0);      // 移到第一位
    fields.MoveField("Status", -1);   // 移到最后
    
    // 使用 DisplayOrder 控制顺序
    fields.GetField("Name").DisplayOrder = 10;
    fields.GetField("Code").DisplayOrder = 20;
}
```

---

## 4.3 默认 CRUD 操作

### Index（列表）

列表页自动提供以下功能：

- 分页显示
- 排序支持
- 搜索过滤
- 批量操作

```csharp
// 自定义列表查询
protected override IEnumerable<Product> Search(Pager p)
{
    var name = p["name"];
    var start = p["dtStart"].ToDateTime();
    var end = p["dtEnd"].ToDateTime();
    
    return Product.Search(name, start, end, p);
}
```

### Detail（详情）

详情页展示单条数据的完整信息：

```csharp
// 访问路径：/Admin/Product/Detail/123
// 自动根据主键加载数据
```

### Add / Insert（添加）

添加功能包括：

- **Add**：显示添加表单
- **Insert**：处理表单提交

```csharp
// 自定义添加逻辑
protected override Int32 OnInsert(Product entity)
{
    // 添加前处理
    entity.CreateTime = DateTime.Now;
    entity.CreateUser = ManageProvider.User?.Name;
    
    return base.OnInsert(entity);
}
```

### Edit / Update（修改）

修改功能包括：

- **Edit**：显示编辑表单（预填充数据）
- **Update**：处理表单提交

```csharp
// 自定义更新逻辑
protected override Int32 OnUpdate(Product entity)
{
    // 更新前处理
    entity.UpdateTime = DateTime.Now;
    entity.UpdateUser = ManageProvider.User?.Name;
    
    return base.OnUpdate(entity);
}
```

### Delete（删除）

```csharp
// 自定义删除逻辑
protected override Int32 OnDelete(Product entity)
{
    // 软删除示例
    entity.IsDeleted = true;
    return entity.Update();
    
    // 或调用基类进行物理删除
    // return base.OnDelete(entity);
}
```

---

## 4.4 数据校验（Valid 方法）

`Valid` 方法在保存数据前进行校验：

```csharp
protected override Boolean Valid(Product entity, DataObjectMethodType type, Boolean post)
{
    if (post)
    {
        // 表单提交后的校验
        if (entity.Name.IsNullOrEmpty())
            throw new ArgumentNullException(nameof(entity.Name), "名称不能为空");
        
        if (entity.Price <= 0)
            throw new ArgumentException("价格必须大于0", nameof(entity.Price));
        
        // 唯一性校验
        if (type == DataObjectMethodType.Insert)
        {
            var exist = Product.FindByCode(entity.Code);
            if (exist != null)
                throw new ArgumentException($"编码 {entity.Code} 已存在");
        }
    }
    
    return base.Valid(entity, type, post);
}
```

**参数说明**：

| 参数 | 类型 | 说明 |
|------|------|------|
| entity | TEntity | 当前实体对象 |
| type | DataObjectMethodType | 操作类型（Insert/Update/Delete） |
| post | Boolean | 是否为表单提交（true=提交后校验，false=显示表单前） |

---

## 4.5 操作按钮定制

### 工具栏按钮

在列表页顶部添加自定义按钮：

```csharp
static ProductController()
{
    // 添加工具栏按钮
    ListFields.AddDataField(new ButtonField
    {
        Name = "Export",
        DisplayName = "导出报表",
        Url = "/Admin/Product/ExportReport",
        Icon = "fa-download",
        Target = "_blank"
    });
}
```

通过 `MenuOrder` 特性添加菜单按钮：

```csharp
[EntityAuthorize(PermissionFlags.Detail)]
[DisplayName("导出报表")]
[MenuOrder(10)]
public ActionResult ExportReport()
{
    var list = Product.FindAll();
    // 导出逻辑
    return File(bytes, "application/octet-stream", "report.xlsx");
}
```

### 行内操作按钮

在列表每行添加操作按钮：

```csharp
static ProductController()
{
    // 添加行内按钮
    ListFields.AddDataField(new LinkField
    {
        Name = "Publish",
        DisplayName = "发布",
        Url = "/Admin/Product/Publish?id={Id}",
        DataAction = "action",
        Icon = "fa-paper-plane"
    });
}
```

---

## 4.6 关联跳转与链接字段

### 关联跳转

将字段设置为可点击链接，跳转到关联数据：

```csharp
static ProductController()
{
    // 分类字段关联跳转
    var category = ListFields.GetField("CategoryId") as ListField;
    if (category != null)
    {
        category.Url = "/Admin/Category?id={CategoryId}";
        category.DisplayName = "分类";
        category.MapField = "CategoryName";  // 显示关联名称
    }
}
```

### 链接字段配置

```csharp
static ProductController()
{
    // 创建链接字段
    var link = new LinkField
    {
        Name = "ViewOrders",
        DisplayName = "查看订单",
        Url = "/Admin/Order?productId={Id}",
        Target = "_blank"
    };
    
    ListFields.AddDataField(link);
}
```

---

## 4.7 统计行（Stat）

在列表底部显示统计信息：

```csharp
protected override IDictionary<String, Object> GetStatistics(IEnumerable<Product> list)
{
    var stats = new Dictionary<String, Object>
    {
        ["TotalCount"] = list.Count(),
        ["TotalPrice"] = list.Sum(e => e.Price),
        ["AvgPrice"] = list.Average(e => e.Price)
    };
    
    return stats;
}
```

页面显示效果：

```
+--------+--------+--------+
| 名称   | 价格   | 数量   |
+--------+--------+--------+
| 产品A  | 100.00 | 50     |
| 产品B  | 200.00 | 30     |
+--------+--------+--------+
| 合计   | 300.00 | 80     |  <- 统计行
+--------+--------+--------+
```

---

## 4.8 批量操作（启用/禁用/删除）

魔方内置批量操作支持：

### 批量启用/禁用

```csharp
// 控制器中自动支持批量启用/禁用
// 要求实体有 Enable 字段

// 自定义批量启用逻辑
[EntityAuthorize(PermissionFlags.Update)]
public ActionResult SetEnable(Boolean enable)
{
    var ids = GetIds();
    var list = Product.FindByIds(ids);
    
    foreach (var item in list)
    {
        item.Enable = enable;
        item.Update();
    }
    
    return JsonRefresh($"已{(enable ? "启用" : "禁用")} {list.Count} 条记录");
}
```

### 批量删除

```csharp
// 内置批量删除支持
// 通过勾选复选框 + 点击删除按钮触发

// 自定义批量删除逻辑
protected override Int32 OnDeleteAll(IEnumerable<Product> list)
{
    var count = 0;
    foreach (var item in list)
    {
        // 软删除
        item.IsDeleted = true;
        item.Update();
        count++;
    }
    return count;
}
```

---

## 4.9 局部修改对象属性

> 详细教程：https://newlifex.com/cube/how_to_update

### 部分字段更新

在某些场景下，只需要更新实体的部分字段：

```csharp
[HttpPost]
public ActionResult UpdateStatus(Int32 id, Int32 status)
{
    var entity = Product.FindById(id);
    if (entity == null)
        return Json(500, null, "产品不存在");
    
    // 只更新 Status 字段
    entity.Status = status;
    entity.Update();  // XCode 会自动只更新变化的字段
    
    return Json(0, null, "状态更新成功");
}
```

### 使用 Dirty 机制

XCode 的脏数据机制自动跟踪字段变化：

```csharp
var entity = Product.FindById(id);

// 修改字段
entity.Name = "新名称";
entity.Price = 199.00M;

// Update 只会更新 Name 和 Price 字段
// 生成的 SQL：UPDATE Product SET Name='新名称', Price=199.00 WHERE Id=123
entity.Update();
```

### 批量部分更新

```csharp
// 批量更新状态
Product.Update(
    Product._.Status == newStatus,           // SET 子句
    Product._.CategoryId == categoryId       // WHERE 子句
);
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **实体控制器基础**：EntityController 的继承和配置
2. **字段配置**：ListFields、FormFields、DetailFields 的用法
3. **CRUD 定制**：重写 OnInsert/OnUpdate/OnDelete 方法
4. **数据校验**：Valid 方法的使用
5. **按钮定制**：工具栏和行内按钮的添加
6. **统计和批量操作**：Stat 统计行和批量处理

**下一步**：

- 学习 [数据导入导出](数据导入导出.md) 功能
- 了解 [字段元数据](字段元数据.md) 的高级配置

---

## 参考资源

- [局部修改对象属性的巧妙实现](https://newlifex.com/cube/how_to_update)
- [魔方功能特点与最佳实践](https://newlifex.com/cube/feature)
