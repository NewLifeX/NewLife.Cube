# 第14章 视图体系

> 本章介绍魔方的 Razor 视图体系，包括视图覆写机制、嵌入式资源和常用视图模板。
> 
> 视图体系是魔方页面展示的核心，理解它有助于进行页面定制。

---

## 14.1 Razor 视图体系概述

### 视图文件结构

魔方的视图文件遵循 ASP.NET Core MVC 的标准结构：

```
Areas/
└── Admin/
    └── Views/
        ├── _ViewImports.cshtml
        ├── _ViewStart.cshtml
        ├── Shared/
        │   ├── _Layout.cshtml
        │   ├── _Layout_Header.cshtml
        │   ├── _Layout_Footer.cshtml
        │   ├── _Left.cshtml
        │   ├── _List_Toolbar.cshtml
        │   ├── _List_Search.cshtml
        │   ├── _List_Data.cshtml
        │   ├── _Form_Header.cshtml
        │   ├── _Form_Body.cshtml
        │   └── _Form_Item.cshtml
        ├── User/
        │   ├── Index.cshtml
        │   ├── Form.cshtml
        │   └── Detail.cshtml
        └── Product/
            ├── Index.cshtml
            └── Form.cshtml
```

### 视图查找顺序

魔方按以下顺序查找视图：

1. `Areas/{Area}/Views/{Controller}/{Action}.cshtml`
2. `Areas/{Area}/Views/Shared/{Action}.cshtml`
3. `Views/Shared/{Action}.cshtml`
4. 嵌入式资源中的视图

---

## 14.2 视图覆写机制

### 子项目同路径覆盖

在子项目中创建同名视图文件即可覆盖魔方默认视图：

```
MyWebApp/                          # 子项目
└── Areas/
    └── Admin/
        └── Views/
            └── User/
                └── Index.cshtml   # 覆盖默认用户列表页
```

### 覆写示例

覆盖产品列表页：

```csharp
// 1. 创建目录结构
// Areas/Admin/Views/Product/Index.cshtml

// 2. 编写自定义视图
@model Pager
@{
    ViewBag.Title = "产品管理";
}

<div class="content-wrapper">
    <section class="content-header">
        <h1>@ViewBag.Title</h1>
    </section>
    
    <section class="content">
        <!-- 自定义内容 -->
        @Html.Partial("_List_Toolbar")
        @Html.Partial("_List_Search")
        @Html.Partial("_List_Data")
    </section>
</div>
```

---

## 14.3 嵌入式资源（CubeEmbeddedFileProvider）

### 嵌入式资源原理

魔方将默认视图作为嵌入式资源打包在 DLL 中：

```csharp
// 注册嵌入式资源提供程序
services.Configure<RazorViewEngineOptions>(options =>
{
    options.FileProviders.Add(new CubeEmbeddedFileProvider(typeof(CubeService).Assembly));
});
```

### 主题皮肤的嵌入式资源

各主题皮肤包同样使用嵌入式资源：

```csharp
// AdminLTE 主题
options.FileProviders.Add(new CubeEmbeddedFileProvider(typeof(AdminLTEModule).Assembly));

// Tabler 主题
options.FileProviders.Add(new CubeEmbeddedFileProvider(typeof(TablerModule).Assembly));
```

---

## 14.4 常用视图模板

### 列表页（List.cshtml）

```html
@model Pager
@{
    var page = Model;
    var fields = ViewBag.Fields as IList<DataField>;
    var list = ViewBag.Page as IList<IEntity>;
}

<div class="box">
    <!-- 工具栏 -->
    @Html.Partial("_List_Toolbar")
    
    <!-- 搜索区 -->
    @Html.Partial("_List_Search")
    
    <!-- 数据表格 -->
    <div class="box-body table-responsive no-padding">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th><input type="checkbox" id="checkAll" /></th>
                    @foreach (var field in fields)
                    {
                        <th>@field.DisplayName</th>
                    }
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entity in list)
                {
                    <tr>
                        <td><input type="checkbox" name="keys" value="@entity["Id"]" /></td>
                        @foreach (var field in fields)
                        {
                            <td>@field.GetValue(entity)</td>
                        }
                        <td>
                            <a href="Edit/@entity["Id"]">编辑</a>
                            <a href="Delete/@entity["Id"]" onclick="return confirm('确定删除？')">删除</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- 分页 -->
    @Html.Partial("_List_Pager")
</div>
```

### 表单页（Form.cshtml / AddForm / EditForm）

```html
@model IEntity
@{
    var entity = Model;
    var fields = ViewBag.Fields as IList<DataField>;
}

<form action="@(entity.IsNullKey ? "Insert" : "Update")" method="post">
    @Html.AntiForgeryToken()
    
    @if (!entity.IsNullKey)
    {
        <input type="hidden" name="Id" value="@entity["Id"]" />
    }
    
    <div class="box-body">
        @foreach (var field in fields)
        {
            @Html.Partial("_Form_Item", new { Field = field, Entity = entity })
        }
    </div>
    
    <div class="box-footer">
        <button type="submit" class="btn btn-primary">保存</button>
        <a href="Index" class="btn btn-default">返回</a>
    </div>
</form>
```

### 详情页（Detail.cshtml）

```html
@model IEntity
@{
    var entity = Model;
    var fields = ViewBag.Fields as IList<DataField>;
}

<div class="box">
    <div class="box-header">
        <h3 class="box-title">详情</h3>
    </div>
    
    <div class="box-body">
        <table class="table table-bordered">
            @foreach (var field in fields)
            {
                <tr>
                    <th style="width: 200px;">@field.DisplayName</th>
                    <td>@field.GetValue(entity)</td>
                </tr>
            }
        </table>
    </div>
    
    <div class="box-footer">
        <a href="Edit/@entity["Id"]" class="btn btn-primary">编辑</a>
        <a href="Index" class="btn btn-default">返回</a>
    </div>
</div>
```

### 树形列表（ListTree.cshtml）

```html
@model Pager
@{
    var tree = ViewBag.Tree as IList<IEntity>;
}

<div class="box">
    <div class="box-body">
        <ul class="tree-view">
            @await Html.PartialAsync("_TreeNode", tree)
        </ul>
    </div>
</div>

@* _TreeNode.cshtml *@
@model IList<IEntity>
@foreach (var node in Model)
{
    <li>
        <span>@node["Name"]</span>
        @if (node["Childs"] is IList<IEntity> children && children.Count > 0)
        {
            <ul>
                @await Html.PartialAsync("_TreeNode", children)
            </ul>
        }
    </li>
}
```

---

## 14.5 部分视图一览

### 列表页部分视图

| 视图 | 说明 |
|------|------|
| _List_Toolbar | 工具栏（添加、删除、导出等按钮） |
| _List_Search | 搜索区域 |
| _List_Data | 数据表格 |
| _List_Pager | 分页组件 |

### 表单页部分视图

| 视图 | 说明 |
|------|------|
| _Form_Header | 表单头部 |
| _Form_Body | 表单主体 |
| _Form_Item | 单个表单项 |
| _Form_Footer | 表单底部（提交按钮等） |

### 使用部分视图

```html
<!-- 引用部分视图 -->
@Html.Partial("_List_Toolbar")

<!-- 带参数的部分视图 -->
@Html.Partial("_Form_Item", new { Field = field, Entity = entity })

<!-- 异步部分视图 -->
@await Html.PartialAsync("_List_Data", Model)
```

---

## 视图继承与复用

### 使用 Layout

```html
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
```

### 定义 Section

```html
<!-- _Layout.cshtml -->
<head>
    @RenderSection("Styles", required: false)
</head>
<body>
    @RenderBody()
    @RenderSection("Scripts", required: false)
</body>

<!-- 子视图 -->
@section Styles {
    <link href="custom.css" rel="stylesheet" />
}

@section Scripts {
    <script src="custom.js"></script>
}
```

---

## 本章小结

通过本章学习，你应该掌握了：

1. **视图结构**：Areas/Views 的目录组织
2. **视图覆写**：同路径覆盖机制
3. **嵌入式资源**：理解默认视图的加载方式
4. **常用模板**：列表页、表单页、详情页的结构
5. **部分视图**：复用视图组件的方法

**下一步**：

- 学习 [自定义列表页](自定义列表页.md) 进行列表页定制
- 了解 [自定义表单页](自定义表单页.md) 的表单定制

---

## 参考资源

- [魔方从零开始 VS2022+NET8+MVC（下）](https://newlifex.com/cube/cube_zero_start_vs2022_net8_mvc_02)
